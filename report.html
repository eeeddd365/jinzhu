<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç  | ç‡Ÿé‹å ±è¡¨èˆ‡å‚™æ–™çµ±è¨ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .print-only { display: none; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block; }
            body { background: white; padding: 0; }
            .print-card { border: 1px solid #eee; box-shadow: none !important; margin-bottom: 20px; page-break-inside: avoid; }
            .page-break { page-break-before: always; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 no-print gap-4">
            <div>
                <h1 class="text-3xl font-bold text-p-green font-serif">ç‡Ÿé‹å ±è¡¨çµ±è¨ˆ</h1>
                <p class="text-stone-400 text-sm mt-1 uppercase tracking-widest">Operation Report & Analytics</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.print()" class="bg-white border-2 border-p-green text-p-green px-6 py-2 rounded-xl font-bold hover:bg-emerald-50 transition">ğŸ–¨ï¸ åˆ—å° PDF</button>
                <button onclick="exportComprehensiveExcel()" class="bg-p-green text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:opacity-90 transition">ğŸ“Š å°å‡ºçµ±æ•´ Excel</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-sm border mb-8 no-print text-left">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-xs font-bold text-stone-400 mb-2 uppercase">æŸ¥è©¢æ—¥æœŸ</label>
                    <input type="date" id="report-date" onchange="fetchData()" class="w-full border p-3 rounded-xl bg-stone-50 outline-none focus:border-p-gold">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-400 mb-2 uppercase">æ´»å‹•ä»£è™Ÿéæ¿¾</label>
                    <select id="report-campaign" onchange="fetchData()" class="w-full border p-3 rounded-xl bg-stone-50 outline-none focus:border-p-gold">
                        <option value="all">æ‰€æœ‰ä¾†æº (å«ä¸€èˆ¬èˆ‡æ´»å‹•)</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="fetchData()" class="w-full bg-stone-800 text-white py-3 rounded-xl font-bold hover:bg-black transition">åˆ·æ–°æ•¸æ“šè³‡æ–™</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-[2rem] shadow-sm border overflow-hidden print-card">
                    <div class="bg-stone-50 p-5 border-b flex justify-between items-center">
                        <h3 class="font-bold text-p-green font-serif italic">å‚™æ–™ç¸½è¨ˆ (å»šæˆ¿ç”¨)</h3>
                        <span id="total-items-count" class="bg-p-gold text-white text-[10px] px-2 py-1 rounded-md font-bold">0 å“é …</span>
                    </div>
                    <div class="p-2 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left">
                            <tbody id="summary-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-[2rem] shadow-sm border overflow-hidden print-card">
                    <div class="bg-p-green p-5 border-b flex justify-between items-center">
                        <h3 class="font-bold text-white font-serif italic">è¨‚å–®æ˜ç´° (æ ¸å°ç”¨)</h3>
                        <span id="order-count-tag" class="text-white/60 text-xs font-bold">å…± 0 ç­†è¨‚å–®</span>
                    </div>
                    <div id="detail-container" class="p-6 space-y-8 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // åˆå§‹åŒ–æ—¥æœŸç‚ºä»Šæ—¥
        document.getElementById('report-date').valueAsDate = new Date();

        async function init() {
            // è¼‰å…¥æ´»å‹•ä»£è™Ÿæ¸…å–®
            const { data } = await _s.from('campaign_settings').select('*');
            if(data) {
                document.getElementById('report-campaign').innerHTML += data.map(c => `<option value="${c.code_name}">${c.code_name}</option>`).join('');
            }
            fetchData();
        }

        async function fetchData() {
            const date = document.getElementById('report-date').value;
            const campaign = document.getElementById('report-campaign').value;

            let query = _s.from('orders').select('*').order('created_at', {ascending: true});
            
            // æ—¥æœŸç¯©é¸
            if(date) {
                query = query.gte('created_at', `${date}T00:00:00Z`).lte('created_at', `${date}T23:59:59Z`);
            }

            // æ´»å‹•ç¯©é¸
            if(campaign !== 'all') {
                query = query.eq('campaign_code', campaign);
            }

            const { data: orders, error } = await query;
            if(error) return alert("è®€å–å¤±æ•—");

            processReports(orders || []);
        }

        function processReports(orders) {
            const summary = {};
            let orderHtml = "";

            orders.forEach((o, index) => {
                // 1. è™•ç†å½™ç¸½é‚è¼¯
                o.order_content.forEach(item => {
                    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼å»é™¤æ•¸é‡ x2 ç­‰å¹²æ“¾ï¼ŒæŠ“å–ç´”å“å
                    const cleanName = item.name.replace(/ x\d+/g, "");
                    const qtyMatch = item.name.match(/ x(\d+)/);
                    const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;

                    if (!summary[cleanName]) summary[cleanName] = 0;
                    summary[cleanName] += qty;
                });

                // 2. è™•ç†æ˜ç´° HTML
                orderHtml += `
                    <div class="pb-6 border-b border-stone-100 last:border-0 text-left">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-p-gold font-bold text-lg">#${index + 1} ${o.customer_name}</span>
                                <span class="ml-3 text-xs text-stone-400">${o.phone}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] bg-stone-100 px-2 py-1 rounded font-bold uppercase">${o.campaign_code || 'ä¸€èˆ¬é ç´„'}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-xs text-stone-500 mb-2">
                            <span>æ¡Œè™Ÿ: ${o.table_no || 'æœªå¡«'}</span>
                            <span>å¤§äºº: ${o.adult_count||0} / å°å­©: ${o.kid_count||0}</span>
                        </div>
                        <ul class="space-y-1">
                            ${o.order_content.map(i => `<li class="text-sm font-medium text-p-green flex justify-between"><span>â€¢ ${i.name}</span> <span class="font-serif">$${i.price}</span></li>`).join('')}
                        </ul>
                        ${o.note ? `<p class="mt-3 text-[11px] bg-amber-50 p-2 rounded text-amber-700 italic">å‚™è¨»: ${o.note}</p>` : ''}
                    </div>
                `;
            });

            // æ¸²æŸ“å½™ç¸½è¡¨æ ¼
            const sortedSummary = Object.entries(summary).sort((a,b) => b[1] - a[1]);
            document.getElementById('summary-body').innerHTML = sortedSummary.map(([name, count]) => `
                <tr class="border-b last:border-0 hover:bg-stone-50">
                    <td class="p-4 text-sm font-bold text-slate-700">${name}</td>
                    <td class="p-4 text-right"><span class="text-lg font-black text-p-green font-serif">${count}</span> <span class="text-[10px] text-stone-400">ä»½</span></td>
                </tr>
            `).join('');

            document.getElementById('detail-container').innerHTML = orders.length ? orderHtml : '<p class="text-center text-stone-300 py-10">æ­¤æ—¥æœŸæš«ç„¡è¨‚å–®</p>';
            document.getElementById('total-items-count').innerText = `${sortedSummary.length} å“é …`;
            document.getElementById('order-count-tag').innerText = `å…± ${orders.length} ç­†è¨‚å–®`;
            
            window.currentReportData = { summary: sortedSummary, orders };
        }

        async function exportComprehensiveExcel() {
            const data = window.currentReportData;
            if(!data) return alert("è«‹å…ˆæŸ¥è©¢æ•¸æ“š");

            const dateStr = document.getElementById('report-date').value;

            // 1. å½™ç¸½å·¥ä½œè¡¨
            const ws_summary = XLSX.utils.json_to_sheet(data.summary.map(s => ({ "é¤é»åç¨±": s[0], "ç¸½æ•¸é‡": s[1] })));

            // 2. æ˜ç´°å·¥ä½œè¡¨
            const ws_detail = XLSX.utils.json_to_sheet(data.orders.map(o => ({
                "è¨‚å–®æ™‚é–“": new Date(o.created_at).toLocaleString(),
                "é¡§å®¢å§“å": o.customer_name,
                "è¯çµ¡é›»è©±": o.phone,
                "æ´»å‹•ä¾†æº": o.campaign_code,
                "æ¡Œè™Ÿ": o.table_no,
                "å¤§äºº": o.adult_count,
                "å°å­©": o.kid_count,
                "å…§å®¹": o.order_content.map(i => i.name).join(' | '),
                "ç¸½é¡": o.total_price,
                "å‚™è¨»": o.note
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws_summary, "å‚™æ–™ç¸½è¨ˆ");
            XLSX.utils.book_append_sheet(wb, ws_detail, "è¨‚å–®æ˜ç´°");

            XLSX.writeFile(wb, `çœŸç ç‡Ÿé‹å ±è¡¨_${dateStr}.xlsx`);
        }

        init();
    </script>
</body>
</html>
