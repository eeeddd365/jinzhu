<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç  | è¨‚å–®å³æ™‚ç›£æ§ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-gold: #b89150; --p-green: #004d40; }
        body { background-color: #00251a; color: #e0e0e0; font-family: 'Noto Sans TC', sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        
        /* è¨‚å–®å¡ç‰‡é€²å…¥å‹•ç•« */
        .order-card { animation: slideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* å·²è™•ç†æ¶ˆå¤±å‹•ç•« */
        .fade-out { 
            opacity: 0 !important; 
            transform: scale(0.8) !important; 
            transition: all 0.5s ease; 
            pointer-events: none;
        }

        .gold-glow { box-shadow: 0 0 20px rgba(184, 145, 80, 0.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1a4d3a; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="notice-overlay" onclick="enableSystem()" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center cursor-pointer backdrop-blur-md">
        <div class="text-center bg-white p-12 rounded-[3rem] shadow-2xl max-w-sm">
            <div class="text-7xl mb-6">ğŸ“¢</div>
            <h2 class="text-3xl font-black mb-3 text-[#004d40] font-serif">ç›£æ§ç³»çµ±å•Ÿå‹•</h2>
            <p class="text-gray-400 mb-8">é»æ“Šå¾Œé–‹å§‹æ¥æ”¶å³æ™‚è¨‚å–®<br>ä¸¦å•Ÿç”¨èªéŸ³å»£æ’­åŠŸèƒ½</p>
            <div class="bg-[#b89150] text-white py-4 px-10 rounded-full font-bold text-lg animate-pulse">é–‹å•ŸèªéŸ³ç›£æ§</div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div class="text-center md:text-left">
                <div class="flex items-center gap-3 justify-center md:justify-start">
                    <img src="https://www.jinzhu.com.tw/images/Jinzhu_logo.svg" class="h-10 brightness-200" style="filter: brightness(0) invert(1) sepia(1) saturate(5) hue-rotate(10deg);">
                    <h1 class="text-3xl font-black text-[#b89150] font-serif tracking-widest">è¨‚å–®ç›£æ§ä¸­å¿ƒ</h1>
                </div>
                <p id="conn-status" class="text-amber-500 text-xs mt-3 font-bold tracking-widest uppercase">Initializing System...</p>
            </div>
            <div class="flex items-center gap-6">
                <div id="clock" class="text-3xl font-mono font-bold text-white bg-black/30 px-6 py-2 rounded-2xl border border-white/10 tracking-tighter">00:00:00</div>
            </div>
        </header>

        <div id="order-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>

        <div id="no-order-hint" class="text-center py-40 text-emerald-900/30">
            <div class="text-8xl mb-4">ğŸ¥¢</div>
            <p class="text-xl font-serif">ç›®å‰å°šç„¡å¾…è™•ç†é å®š</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let systemActive = false;

        // å•Ÿå‹•ç³»çµ±ä¸¦é ç†±èªéŸ³
        function enableSystem() {
            systemActive = true;
            document.getElementById('notice-overlay').classList.add('hidden');
            speak("ç³»çµ±å·²å•Ÿå‹•");
        }

        // èªéŸ³å»£æ’­åŠŸèƒ½
        function speak(text) {
            if (!window.speechSynthesis || !systemActive) return;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-TW';
            utter.rate = 1.0;
            utter.pitch = 1.0;
            window.speechSynthesis.speak(utter);
        }

        // ç›£è½æ–°è¨‚å–®
        _s.channel('orders_realtime')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
              console.log('New Order:', payload.new);
              speak("æœ‰ä¸€ç­†æ–°é å®š"); // èªéŸ³é€šçŸ¥
              renderOrder(payload.new);
          })
          .subscribe(status => {
              const el = document.getElementById('conn-status');
              if(status === 'SUBSCRIBED') {
                  el.innerText = "ğŸŸ¢ ç³»çµ±å·²åŒæ­¥ | å¯¦æ™‚é»é¤ç›£æ§ä¸­";
                  el.className = "text-emerald-400 text-xs mt-3 font-bold tracking-widest";
              }
          });

        function renderOrder(order) {
            document.getElementById('no-order-hint').classList.add('hidden');
            const grid = document.getElementById('order-grid');
            
            const card = document.createElement('div');
            card.id = `order-${order.id}`;
            card.className = "order-card bg-white rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col gold-glow";
            
            const time = new Date(order.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const items = typeof order.order_content === 'string' ? JSON.parse(order.order_content) : order.order_content;
            
            card.innerHTML = `
                <div class="p-6 bg-stone-50 border-b border-stone-100 flex justify-between items-center">
                    <div>
                        <span class="text-[10px] bg-[#b89150] text-white px-2 py-0.5 rounded-md font-bold uppercase mb-1 inline-block">New Order</span>
                        <h3 class="text-2xl font-black text-[#004d40] font-serif">${order.customer_name}</h3>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-black text-[#b89150] font-mono">$${order.total_price}</p>
                        <p class="text-[10px] text-stone-400 font-bold">${time}</p>
                    </div>
                </div>
                
                <div class="p-6 flex-1 custom-scrollbar overflow-y-auto max-h-60">
                    <div class="space-y-3">
                        ${items.map(i => `
                            <div class="flex gap-3 items-start">
                                <div class="w-1.5 h-1.5 bg-[#b89150] rounded-full mt-2 flex-shrink-0"></div>
                                <p class="text-stone-700 text-base font-bold leading-tight">${i.name}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>

                ${order.note ? `
                <div class="px-6 pb-2">
                    <div class="bg-amber-50 border border-amber-100 p-3 rounded-2xl">
                        <p class="text-[10px] text-amber-600 font-black uppercase mb-1">ç‰¹åˆ¥å‚™è¨»</p>
                        <p class="text-amber-900 text-xs font-medium">${order.note}</p>
                    </div>
                </div>` : ''}

                <div class="p-6 pt-4 flex flex-col gap-3">
                    <div class="flex items-center justify-between text-stone-400 text-[11px] font-bold px-1">
                        <span>TEL: ${order.phone}</span>
                    </div>
                    <button onclick="markAsDone('${order.id}')" class="w-full bg-[#004d40] text-white py-4 rounded-2xl font-black text-sm tracking-widest hover:bg-emerald-800 transition shadow-lg active:scale-95">
                        ç¢ºèªå·²è™•ç†
                    </button>
                </div>
            `;
            
            grid.prepend(card);
        }

        // å·²è™•ç†å‹•ä½œ (åƒ…å‰ç«¯ç§»é™¤)
        function markAsDone(id) {
            const el = document.getElementById(`order-${id}`);
            if(el) {
                el.classList.add('fade-out');
                setTimeout(() => {
                    el.remove();
                    if(document.getElementById('order-grid').children.length === 0) {
                        document.getElementById('no-order-hint').classList.remove('hidden');
                    }
                }, 500);
            }
        }

        // æ™‚é˜
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour12: false});
        }, 1000);
    </script>
</body>
</html>
