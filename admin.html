<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸç ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --pearl-green: #004d40; --pearl-gold: #b89150; }
        .bg-pearl { background-color: var(--pearl-green); }
        .text-pearl { color: var(--pearl-green); }
        .border-pearl { border-color: var(--pearl-gold); }
        .tab-active { border-bottom: 4px solid var(--pearl-gold); color: var(--pearl-green); font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 flex min-h-screen">

    <aside class="w-64 bg-pearl text-white flex flex-col shadow-xl">
        <div class="p-6 text-center border-b border-green-800">
            <h1 class="text-xl font-bold tracking-widest text-pearl-gold">çœŸç ç®¡ç†å¾Œå°</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showSection('orders')" class="w-full text-left p-3 rounded hover:bg-green-800">ğŸ“‹ è¨‚å–®ç®¡ç†</button>
            <button onclick="showSection('menu')" class="w-full text-left p-3 rounded hover:bg-green-800">ğŸ± èœå–®ç·¨è¼¯</button>
            <button onclick="showSection('categories')" class="w-full text-left p-3 rounded hover:bg-green-800">ğŸ—‚ï¸ åˆ†é¡ç®¡ç†</button>
            <button onclick="showSection('settings')" class="w-full text-left p-3 rounded hover:bg-green-800">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        
        <section id="sec-orders" class="space-y-6">
            <h2 class="text-2xl font-bold text-pearl">å³æ™‚è¨‚å–®</h2>
            <div id="order-list" class="grid gap-4">
                </div>
        </section>

        <section id="sec-categories" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-pearl">èœå–®åˆ†é¡è¨­å®š</h2>
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-cat-name" placeholder="æ–°å¢åˆ†é¡åç¨± (å¦‚: ç¶“å…¸å°èœ)" class="flex-1 border p-2 rounded">
                    <button onclick="addCategory()" class="bg-pearl text-white px-6 py-2 rounded">æ–°å¢</button>
                </div>
                <table class="w-full text-left">
                    <thead><tr class="border-b text-gray-400"><th class="pb-2">åç¨±</th><th class="pb-2">ç‹€æ…‹</th><th class="pb-2">æ“ä½œ</th></tr></thead>
                    <tbody id="cat-table-body"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pearl">é¤é»ç®¡ç†</h2>
                <button onclick="openMenuModal()" class="bg-pearl text-white px-6 py-2 rounded-full">+ æ–°å¢é¤é»</button>
            </div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
        </section>

        <section id="sec-settings" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-pearl">é¤å»³è³‡è¨Šèˆ‡ Logo</h2>
            <div class="bg-white p-6 rounded-lg shadow-sm max-w-md">
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2 font-medium">é¤å»³ Logo ä¸Šå‚³</label>
                        <input type="file" id="logo-file" accept="image/*" class="w-full">
                        <button onclick="uploadLogo()" class="mt-2 bg-pearl-gold text-white px-4 py-2 rounded text-sm">åŸ·è¡Œä¸Šå‚³</button>
                    </div>
                    <div id="current-logo-display" class="pt-4 border-t">
                        <p class="text-xs text-gray-400 mb-2">ç›®å‰é è¦½ï¼š</p>
                        <img id="preview-logo" src="" class="h-16 object-contain hidden">
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="menu-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 bg-gray-50 border-b flex justify-between">
                <h3 class="font-bold text-lg">ç·¨è¼¯é¤é»ç´°ç¯€</h3>
                <button onclick="closeMenuModal()">âœ•</button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="text" id="m-name" placeholder="é¤é»åç¨±" class="w-full border p-2 rounded">
                <textarea id="m-desc" placeholder="é¤é»æè¿°" class="w-full border p-2 rounded"></textarea>
                <div class="flex gap-4">
                    <input type="number" id="m-price" placeholder="åƒ¹æ ¼" class="w-1/2 border p-2 rounded">
                    <select id="m-cat" class="w-1/2 border p-2 rounded"></select>
                </div>
                <div class="flex items-center gap-4 bg-yellow-50 p-3 rounded">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="m-is-set" onchange="toggleSetMenuFields()"> é€™æ˜¯å¥—é¤ (å¦‚äºŒäººé¤)
                    </label>
                    <div id="set-limit-wrap" class="hidden flex items-center gap-2">
                        é¸ <input type="number" id="m-limit" class="w-16 border p-1" value="0"> é …
                    </div>
                </div>
                <div id="set-options-wrap" class="hidden space-y-2">
                    <p class="text-sm font-bold">å¥—é¤å­é¸é … (è«‹ç”¨åŠå‹é€—è™Ÿéš”é–‹åç¨±):</p>
                    <textarea id="m-options" placeholder="ä¾‹å¦‚: ç´…èŒ¶, ç¶ èŒ¶, çƒæ¢…æ±" class="w-full border p-2 rounded"></textarea>
                </div>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-2">
                <button onclick="closeMenuModal()" class="px-4 py-2 bg-gray-300 rounded">å–æ¶ˆ</button>
                <button onclick="saveMenuItem()" class="px-6 py-2 bg-pearl text-white rounded">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½® Supabase ===
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let categories = [];

        // é é¢åˆ‡æ›
        function showSection(name) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${name}`).classList.remove('hidden');
            if(name === 'categories') loadCategories();
            if(name === 'menu') loadMenu();
            if(name === 'orders') loadOrders();
            if(name === 'settings') loadSettings();
        }

        // --- Logo ä¸Šå‚³åŠŸèƒ½ ---
        async function uploadLogo() {
            const file = document.getElementById('logo-file').files[0];
            if(!file) return alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
            
            const fileName = `logo_${Date.now()}.png`;
            const { data, error } = await _supabase.storage.from('assets').upload(fileName, file);
            
            if(error) return alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
            
            const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/assets/${fileName}`;
            await _supabase.from('store_settings').update({ logo_url: publicUrl }).eq('id', 1);
            alert('Logo æ›´æ–°æˆåŠŸï¼');
            loadSettings();
        }

        async function loadSettings() {
            const { data } = await _supabase.from('store_settings').select('*').eq('id', 1).single();
            if(data && data.logo_url) {
                const img = document.getElementById('preview-logo');
                img.src = data.logo_url;
                img.classList.remove('hidden');
            }
        }

        // --- åˆ†é¡ç®¡ç† ---
        async function loadCategories() {
            const { data } = await _supabase.from('categories').select('*').order('sort_order');
            categories = data;
            const body = document.getElementById('cat-table-body');
            body.innerHTML = data.map(c => `
                <tr class="border-b">
                    <td class="py-3">${c.name}</td>
                    <td>${c.is_visible ? 'ğŸŸ¢ é¡¯ç¤ºä¸­' : 'âšª éš±è—'}</td>
                    <td>
                        <button onclick="toggleCatVisibility('${c.id}', ${c.is_visible})" class="text-blue-600 mr-2 text-sm">åˆ‡æ›ç‹€æ…‹</button>
                        <button onclick="deleteCat('${c.id}')" class="text-red-600 text-sm">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
            
            // åŒæ­¥é¤é»ç·¨è¼¯å½ˆçª—çš„åˆ†é¡æ¸…å–®
            const mCat = document.getElementById('m-cat');
            mCat.innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function addCategory() {
            const name = document.getElementById('new-cat-name').value;
            if(!name) return;
            await _supabase.from('categories').insert([{ name }]);
            document.getElementById('new-cat-name').value = '';
            loadCategories();
        }

        async function toggleCatVisibility(id, current) {
            await _supabase.from('categories').update({ is_visible: !current }).eq('id', id);
            loadCategories();
        }

        // --- é¤é»ç®¡ç† (å«éš±è—/ç·¨è¼¯/å¥—é¤) ---
        async function loadMenu() {
            const { data } = await _supabase.from('menu_items').select('*').order('created_at');
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = data.map(i => `
                <div class="bg-white p-4 rounded-lg shadow border-l-4 ${i.is_hidden ? 'border-gray-300 opacity-60' : 'border-pearl-gold'}">
                    <div class="flex justify-between font-bold">
                        <span>${i.name}</span>
                        <span class="text-pearl">$${i.price}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${i.is_set_menu ? `ğŸ± å¥—é¤ (é¸ ${i.selection_limit} é …)` : 'å–®é»é¤é»'}</p>
                    <div class="mt-4 flex gap-2">
                        <button onclick="toggleItemHide('${i.id}', ${i.is_hidden})" class="text-xs border px-2 py-1 rounded">
                            ${i.is_hidden ? 'ğŸ‘ï¸ å–æ¶ˆéš±è—' : 'ğŸš« éš±è—é¤é»'}
                        </button>
                        <button onclick="deleteItem('${i.id}')" class="text-xs border border-red-200 text-red-500 px-2 py-1 rounded">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleSetMenuFields() {
            const isSet = document.getElementById('m-is-set').checked;
            document.getElementById('set-limit-wrap').classList.toggle('hidden', !isSet);
            document.getElementById('set-options-wrap').classList.toggle('hidden', !isSet);
        }

        async function saveMenuItem() {
            const item = {
                name: document.getElementById('m-name').value,
                description: document.getElementById('m-desc').value,
                price: document.getElementById('m-price').value,
                category_id: document.getElementById('m-cat').value,
                is_set_menu: document.getElementById('m-is-set').checked,
                selection_limit: document.getElementById('m-limit').value
            };

            const { data: newItem, error } = await _supabase.from('menu_items').insert([item]).select();
            
            if(!error && item.is_set_menu) {
                const optNames = document.getElementById('m-options').value.split(',').map(s => s.trim());
                const optRecords = optNames.map(name => ({ menu_item_id: newItem[0].id, option_name: name }));
                await _supabase.from('set_menu_options').insert(optRecords);
            }
            
            closeMenuModal();
            loadMenu();
        }

        // --- è¨‚å–®ç®¡ç† ---
        async function loadOrders() {
            const { data } = await _supabase.from('orders').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('order-list');
            list.innerHTML = data.map(o => `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="bg-pearl-gold text-white text-xs px-2 py-1 rounded mr-2">è¨‚å–®</span>
                            <span class="font-bold text-lg">${o.customer_name} (${o.adults}å¤§ ${o.children}å°)</span>
                            <p class="text-sm text-gray-400">${new Date(o.created_at).toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-xl text-pearl">$${o.total_price}</p>
                            <p class="text-xs">${o.phone}</p>
                        </div>
                    </div>
                    <div class="bg-stone-50 p-3 rounded text-sm space-y-1">
                        ${o.order_content.map(i => `
                            <div class="flex justify-between">
                                <span>â€¢ ${i.name} ${i.options ? `<span class="text-blue-600">[${i.options.join(', ')}]</span>` : ''}</span>
                                <span>$${i.price}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // åŸºæœ¬ Modal æ§åˆ¶
        function openMenuModal() { document.getElementById('menu-modal').classList.remove('hidden'); loadCategories(); }
        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        async function toggleItemHide(id, current) { await _supabase.from('menu_items').update({ is_hidden: !current }).eq('id', id); loadMenu(); }
        async function deleteItem(id) { if(confirm('ç¢ºå®šåˆªé™¤é¤é»ï¼Ÿ')) { await _supabase.from('menu_items').delete().eq('id', id); loadMenu(); } }

        // åˆå§‹åŒ–
        showSection('orders');
    </script>
</body>
</html>
