<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç  ADMIN - æ——è‰¦ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; } 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .bg-p-green { background-color: var(--p-green); }
        .text-p-green { color: var(--p-green); }
        .sidebar-btn-active { background-color: var(--p-green); color: white !important; border-left: 4px solid var(--p-gold); }
        .img-contain, #admin-logo-img { object-fit: contain; background: white; image-rendering: -webkit-optimize-contrast; }
        .order-card-completed { opacity: 0.5; filter: grayscale(0.8); background-color: #f1f5f9 !important; border-color: #cbd5e1 !important; }
        #edit-cat-nav { display: flex; overflow-x: auto; white-space: nowrap; padding-bottom: 10px; scrollbar-width: thin; scrollbar-color: var(--p-gold) #f1f1f1; }
        #edit-cat-nav::-webkit-scrollbar { height: 8px; }
        #edit-cat-nav::-webkit-scrollbar-thumb { background: var(--p-gold); border-radius: 10px; }
        .flavor-selected { border-color: var(--p-gold) !important; background-color: var(--p-green) !important; color: white !important; }
        .opt-selected { border: 2.5px solid var(--p-gold) !important; background-color: #fdf6e9 !important; font-weight: bold; }
        .picker-item.active { border-color: var(--p-gold); background-color: #fffbeb; }
        .picker-item.active .check-mark { display: block; }
        .input-mini { font-size: 11px; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; width: 100%; outline: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* å´é‚Šæ¬„ç¸®æ”¾æ¨£å¼é ç•™ */
        aside { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 260px; overflow: hidden; }
        aside.collapsed { width: 85px; }
        aside.collapsed .nav-text { display: none; }
    </style>
</head>
<body class="min-h-screen flex text-slate-700 text-left">

    <aside id="sidebar" class="bg-emerald-950 text-white sticky top-0 h-screen shadow-2xl flex flex-col z-[500]">
        <div class="p-10 text-center opacity-50 text-xs">Sidebar Loading...</div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <section id="sec-orders" class="space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-3xl font-bold text-p-green font-serif">è¨‚å–®ç›£æ§</h2><button onclick="exportXls()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg">ğŸ“Š å°å‡º Excel</button></div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4 text-left text-left">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div><label class="block text-xs font-bold text-stone-400 mb-1">å¿«é€Ÿæ—¥æœŸ</label><select id="filter-date-preset" onchange="setQuickDate(this.value)" class="w-full border p-2 rounded-lg text-sm"><option value="all">ä¸é™æ—¥æœŸ</option><option value="today">ä»Šæ—¥</option><option value="week">æœ¬é€±</option><option value="custom">è‡ªé¸æ—¥æœŸ</option></select></div>
                    <div id="custom-date-box" class="hidden"><label class="block text-xs font-bold text-stone-400 mb-1">è‡ªé¸æ—¥æœŸ</label><input type="date" id="filter-date" class="w-full border p-2 rounded-lg text-sm"></div>
                    <div><label class="block text-xs font-bold text-stone-400 mb-1">æ´»å‹•éæ¿¾</label><select id="filter-campaign" class="w-full border p-2 rounded-lg text-sm"><option value="all">å…¨éƒ¨æ´»å‹•</option></select></div>
                    <div><label class="block text-xs font-bold text-stone-400 mb-1">è™•ç†ç‹€æ…‹</label><select id="filter-status" class="w-full border p-2 rounded-lg text-sm"><option value="all">å…¨éƒ¨</option><option value="pending">æœªå®Œæˆ</option><option value="synced">å·²å®Œæˆ</option></select></div>
                </div>
                <div class="flex gap-2"><input type="text" id="filter-search" class="flex-1 border p-2 rounded-lg text-sm" placeholder="æœå°‹é¡§å®¢å§“åæˆ–é›»è©±..."><button onclick="loadOrders()" class="bg-p-green text-white px-8 py-2 rounded-lg font-bold shadow-md">åŸ·è¡Œç¯©é¸</button><button onclick="resetFilters()" class="text-stone-400 text-xs">é‡ç½®</button></div>
            </div>
            <div id="order-list" class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-left"></div>
        </section>

        <section id="sec-campaigns" class="hidden space-y-6 text-left">
            <h2 class="text-2xl font-bold text-p-green font-serif">æ´»å‹•ä»£è™Ÿç®¡ç†</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm border max-w-md text-left">
                <div class="flex gap-2 mb-6"><input id="new-campaign" class="border flex-1 p-3 rounded-xl text-left" placeholder="æ–°ä»£è™Ÿ (å¦‚ï¼šçˆ¶è¦ªç¯€)"><button onclick="addCampaign()" class="bg-p-green text-white px-6 rounded-xl font-bold shadow-md text-left">æ–°å¢</button></div>
                <div id="campaign-list" class="space-y-2 text-left"></div>
            </div>
        </section>

        <section id="sec-categories" class="hidden space-y-6 text-left">
            <h2 class="text-2xl font-bold text-p-green font-serif text-left">åˆ†é¡ç®¡ç†</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm border max-w-2xl text-left">
                <div class="flex gap-2 mb-6 text-left"><input id="new-cat" class="border flex-1 p-3 rounded-xl text-left" placeholder="æ–°åˆ†é¡åç¨±"><button onclick="addCat()" class="bg-p-green text-white px-6 rounded-xl font-bold shadow-md text-left">æ–°å¢</button></div>
                <table class="w-full text-sm text-left">
                    <thead><tr class="text-stone-400 border-b"><th>æ’åº</th><th>åç¨±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="cat-list-table" class="text-left"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-menu" class="hidden space-y-6 text-left text-left">
            <div class="flex justify-between items-center text-left"><h2 class="text-3xl font-bold text-p-green font-serif text-left">èœå–®ç·¨è¼¯</h2><button onclick="openMenuModal(false)" class="bg-p-green text-white px-6 py-2 rounded-lg shadow-lg font-bold text-left">+ æ–°å¢é¤é»</button></div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border flex gap-4 text-left"><input type="text" id="menu-search" oninput="loadMenu()" class="flex-1 border p-2 rounded-lg text-left" placeholder="æœå°‹èœå..."><select id="menu-cat-filter" onchange="loadMenu()" class="border p-2 rounded-lg text-left"></select></div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 text-left"></div>
        </section>

        <section id="sec-flavors" class="hidden space-y-6 text-left text-left">
            <div class="flex justify-between items-center text-left text-left"><h2 class="text-2xl font-bold text-p-green font-serif text-left">å£å‘³å®šç¾©</h2><button onclick="addFlvGroup()" class="bg-amber-600 text-white px-6 py-2 rounded-xl font-bold shadow-sm text-left">+ æ–°å¢é¸é …çµ„</button></div>
            <div id="flv-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left text-left"></div>
        </section>

        <section id="sec-settings" class="hidden space-y-6 text-left text-left">
            <h2 class="text-2xl font-bold text-p-green font-serif text-left">ç³»çµ±èˆ‡ Logo è¨­å®š</h2>
            <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm max-w-xl text-left text-left text-left">
                <p class="text-xs text-stone-400 mb-4 uppercase font-bold text-left">Logo ä¸Šå‚³ (æ¨è–¦ä½¿ç”¨ SVG)</p>
                <input type="file" id="logo-file" class="w-full border-2 border-dashed p-6 rounded-2xl text-sm mb-4 text-left" accept=".svg,.png,.jpg,.jpeg">
                <div id="current-logo-preview" class="hidden mb-4 text-center text-left"><img id="admin-logo-img" src="" class="max-h-20 mx-auto text-left"></div>
                <button onclick="uploadLogo()" class="w-full bg-p-green text-white py-4 rounded-2xl font-bold shadow-lg transition text-left text-left">ç¢ºèªæ›´æ–° Logo</button>
            </div>
        </section>
    </main>

    <div id="order-edit-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[600] backdrop-blur-sm text-left">
        <div class="bg-white w-full max-w-6xl rounded-3xl overflow-hidden flex flex-col max-h-[95vh] shadow-2xl">
            <div class="p-6 bg-p-green text-white flex justify-between items-center"><h3>ä¿®æ”¹è¨‚å–®</h3><button onclick="closeEditModal()">âœ•</button></div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-2/3 border-r p-4 bg-stone-50 flex flex-col overflow-hidden"><div id="edit-cat-nav" class="mb-2 border-b"></div><div id="edit-menu-grid" class="grid grid-cols-3 gap-3 overflow-y-auto pt-2 no-scrollbar text-left"></div></div>
                <div class="w-1/3 p-4 flex flex-col bg-white text-left"><h4 class="font-bold mb-4">é¤é»æ˜ç´°</h4><div id="edit-cart-list" class="flex-1 space-y-2 overflow-y-auto text-sm"></div><div class="border-t pt-4 mt-2"><div class="flex justify-between text-xl font-bold text-p-green mb-4"><span>ç¸½è¨ˆ</span><span id="edit-total-price">$0</span></div><button onclick="saveOrderChange()" class="w-full bg-[#b89150] text-white py-4 rounded-xl font-bold">ç¢ºèªæ›´æ–°è¨‚å–®è³‡æ–™</button></div></div>
            </div>
        </div>
    </div>

    <div id="edit-flavor-popup" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center p-4 z-[700] backdrop-blur-sm text-left">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 flex flex-col max-h-[85vh] shadow-2xl"><h4 class="font-bold text-lg mb-4 text-p-green" id="edit-pop-title">å£å‘³é¸æ“‡</h4><div id="edit-pop-content" class="space-y-6 overflow-y-auto flex-1"></div><div class="flex gap-3 mt-6"><button onclick="closeEditPop()" class="flex-1 bg-stone-100 py-3 rounded-xl font-bold text-stone-400">å–æ¶ˆ</button><button onclick="confirmEditPop()" class="flex-[2] bg-p-green text-white py-3 rounded-xl font-bold">ç¢ºèªæ›´æ–°</button></div></div>
    </div>

    <div id="set-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[550] text-left">
        <div class="bg-white w-full max-w-2xl rounded-3xl p-6 flex flex-col max-h-[90vh] shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-p-green border-b pb-2 text-center" id="set-modal-title">å¥—é¤åˆ†çµ„å…§å®¹è¨­å®š</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="text-[10px] font-bold text-stone-400 block mb-1">åˆ†çµ„åç¨±</label><input id="g-name" class="w-full border p-3 rounded-xl bg-stone-50"></div>
                <div><label class="text-[10px] font-bold text-stone-400 block mb-1">å¿…é¸æ•¸é‡</label><input id="g-limit" type="number" class="w-full border p-3 rounded-xl bg-stone-50 text-center"></div>
            </div>
            <div class="bg-stone-50 p-4 rounded-2xl border flex-1 flex flex-col overflow-hidden text-left">
                <input type="text" id="set-item-search" oninput="filterPickerItems()" placeholder="æœå°‹å–®å“..." class="w-full p-2 border rounded-full text-xs mb-3">
                <div id="item-picker-list" class="flex-1 overflow-y-auto grid grid-cols-2 gap-2 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-3 border-t flex justify-between items-center"><span id="picker-count" class="text-xs text-stone-400">å·²é¸ 0 é …</span><button onclick="addSelectedToPicks()" class="bg-emerald-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold">+ åŠ å…¥æš«å­˜</button></div>
            </div>
            <div class="mt-4 text-left"><div id="temp-pick-display" class="flex flex-wrap gap-2 mb-4"></div><button onclick="saveFullSet()" id="btn-save-group" class="w-full bg-p-green text-white py-3 rounded-xl font-bold shadow-lg">ç¢ºèªå„²å­˜</button><button onclick="resetSetForm()" id="btn-cancel-edit" class="hidden w-full text-xs text-stone-400 mt-2 underline text-center">å–æ¶ˆç·¨è¼¯æ¨¡å¼</button></div>
            <div class="border-t pt-4 mt-4 overflow-y-auto max-h-40 custom-scrollbar"><div id="saved-groups-view" class="space-y-2"></div></div>
            <button onclick="closeSetModal()" class="mt-4 text-xs text-stone-300 w-full text-center">é—œé–‰</button>
        </div>
    </div>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[500] text-left">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 flex flex-col max-h-[90vh] shadow-2xl">
            <h3 class="font-bold text-xl mb-6 text-p-green border-l-4 border-p-gold pl-3">é¤é»åŸºæœ¬è³‡æ–™</h3>
            <input type="hidden" id="m-id">
            <div class="space-y-4 overflow-y-auto pr-2 custom-scrollbar text-left">
                <input id="m-name" placeholder="åç¨±" class="w-full border p-3 rounded-xl bg-stone-50 font-bold">
                <textarea id="m-desc" placeholder="æè¿°" class="w-full border p-3 rounded-xl bg-stone-50 h-20 text-sm"></textarea>
                <div class="grid grid-cols-2 gap-4"><input id="m-price" type="number" placeholder="å”®åƒ¹" class="border p-3 rounded-xl"><select id="m-cat" class="border p-3 rounded-xl"></select></div>
                <div class="bg-stone-100 p-4 rounded-xl text-left"><p class="text-[10px] font-bold text-stone-500 mb-2 uppercase text-left">å£å‘³æ¨™ç±¤è¨­å®š</p><div id="flv-checks" class="grid grid-cols-2 gap-2 text-left"></div></div>
                <div class="p-2 border-2 border-dashed rounded-xl"><input type="file" id="m-img" class="w-full text-xs"></div>
                <label class="flex items-center gap-3 p-4 bg-emerald-50 rounded-2xl font-bold"><input type="checkbox" id="m-is-set"> å¥—é¤æ¨¡å¼</label>
            </div>
            <div class="flex gap-3 mt-8"><button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-stone-400">å–æ¶ˆ</button><button onclick="saveItem()" class="flex-1 bg-p-green text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜é¤é»</button></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let allMenuItems = [], allCategories = [], curEditOrder = null, editCart = [], curEditItem = null, curEditPopSels = { flavors: {}, groups: {} };
        let reEditIndex = -1, curPicks = [], curItem = null, currentEditingGroupId = null, allCampaigns = [], pickerSelectedItems = [];

        // --- 0. çµ„ä»¶åŒ–è¼‰å…¥ ---
        async function includeSidebar() {
            try {
                const response = await fetch('sidebar.html');
                const content = await response.text();
                document.getElementById('sidebar').innerHTML = content;
                loadSettings(); // åŒæ­¥å´é‚Šæ¬„ Logo
            } catch (err) { console.error("Sidebar è¼‰å…¥å¤±æ•—", err); }
        }

        function toggleSidebar() { 
            const s = document.getElementById('sidebar'); 
            const icon = document.getElementById('collapse-icon');
            s.classList.toggle('collapsed'); 
            if(icon) icon.innerText = s.classList.contains('collapsed') ? 'â–¶' : 'â—€'; 
        }

        async function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('sidebar-btn-active'));
            const targetSec = document.getElementById(`sec-${t}`);
            const targetBtn = document.getElementById(`btn-${t}`);
            if(targetSec) targetSec.classList.remove('hidden');
            if(targetBtn) targetBtn.classList.add('sidebar-btn-active');
            if(t==='orders') { await loadCampaignOptions(); loadOrders(); }
            if(t==='campaigns') loadCampaigns();
            if(t==='categories') loadCats();
            if(t==='menu') { await loadCats(); loadMenu(); }
            if(t==='flavors') loadFlvs();
            if(t==='settings') loadSettings();
        }

        // --- 1. è¨‚å–®ç›£æ§æ ¸å¿ƒ (äººæ•¸ä¿ç•™) ---
        function setQuickDate(val) { document.getElementById('custom-date-box').classList.toggle('hidden', val !== 'custom'); }
        async function loadCampaignOptions() { const { data } = await _s.from('campaign_settings').select('*'); allCampaigns = data || []; document.getElementById('filter-campaign').innerHTML = '<option value="all">å…¨éƒ¨</option>' + allCampaigns.map(c => `<option value="${c.code_name}">${c.code_name}</option>`).join(''); }
        async function loadOrders() {
            const search = document.getElementById('filter-search').value, status = document.getElementById('filter-status').value, preset = document.getElementById('filter-date-preset').value, campaign = document.getElementById('filter-campaign').value;
            let query = _s.from('orders').select('*').order('created_at', {ascending:false});
            if(search) query = query.or(`customer_name.ilike.%${search}%,phone.ilike.%${search}%`);
            if(status !== 'all') query = query.eq('status', status);
            if(campaign !== 'all') query = query.eq('campaign_code', campaign);
            if(preset === 'today') { const d = new Date().toISOString().split('T')[0]; query = query.gte('created_at', `${d}T00:00:00`).lte('created_at', `${d}T23:59:59`); }
            const { data } = await query; window.ordersRef = data || [];
            document.getElementById('order-list').innerHTML = (data || []).map(o => {
                let bTime = ""; if(o.booking_date) { const d = new Date(o.booking_date); bTime = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().substring(0,16); }
                return `<div class="bg-white p-6 rounded-3xl border transition ${o.status==='synced'?'order-card-completed':'border-emerald-200'} text-left text-left">
                    <div class="flex justify-between font-black text-2xl mb-2 text-p-green"><span>${o.customer_name}</span><span class="text-p-gold font-serif">$${o.total_price}</span></div>
                    <div class="text-[10px] text-stone-400 mb-4 font-bold uppercase text-left text-left">ä¸‹å–®ï¼š${new Date(o.created_at).toLocaleString()} | ${o.phone}</div>
                    <div class="grid grid-cols-2 gap-3 mb-6 bg-stone-50 p-4 rounded-2xl text-left text-left text-left text-left">
                        <div class="col-span-2 text-left"><label class="text-[9px] font-black text-stone-400 uppercase">é ç´„æ™‚é–“</label><input type="datetime-local" value="${bTime}" onchange="updateOrderData('${o.id}', 'booking_date', this.value)" class="input-mini"></div>
                        <div class="text-left"><label class="text-[9px] font-black text-stone-400 uppercase">æ¡Œè™Ÿ</label><input type="text" value="${o.table_no||''}" onchange="updateOrderData('${o.id}', 'table_no', this.value)" class="input-mini"></div>
                        <div class="text-left"><label class="text-[9px] font-black text-stone-400 uppercase">æ´»å‹•</label><select onchange="updateOrderData('${o.id}', 'campaign_code', this.value)" class="input-mini"><option value="">ç„¡</option>${allCampaigns.map(c => `<option value="${c.code_name}" ${o.campaign_code===c.code_name?'selected':''}>${c.code_name}</option>`).join('')}</select></div>
                        <div class="col-span-2 flex gap-1 mt-1 text-left"><input type="number" value="${o.adult_count||0}" onchange="updateOrderData('${o.id}','adult_count',this.value)" class="input-mini text-center" title="å¤§äºº"><input type="number" value="${o.kid_count||0}" onchange="updateOrderData('${o.id}','kid_count',this.value)" class="input-mini text-center" title="å°å­©"><input type="number" value="${o.toddler_count||0}" onchange="updateOrderData('${o.id}','toddler_count',this.value)" class="input-mini text-center" title="å¹¼å…’"></div>
                    </div>
                    <div class="space-y-1 mb-8 text-sm text-stone-500 border-l-4 border-p-gold/20 pl-4 font-bold text-left text-left">${o.order_content.map(i => `â€¢ ${i.name}`).join('<br>')}</div>
                    <div class="flex gap-2"><button onclick="openEditOrder('${o.id}')" class="flex-1 bg-stone-100 py-3 rounded-xl font-bold text-xs hover:bg-stone-200 shadow-sm transition">ä¿®æ”¹</button><button onclick="toggleSync('${o.id}', '${o.status}')" class="flex-[1.5] ${o.status==='synced'?'bg-slate-300':'bg-emerald-600'} text-white py-3 rounded-xl text-xs font-bold shadow-lg">${o.status==='synced'?'âœ“ å·²å®Œæˆ':'æ ¸æ”¶é»é¤'}</button></div>
                    <button onclick="delOrder('${o.id}')" class="w-full mt-4 py-2 text-red-200 text-[10px] font-bold text-left">æ°¸ä¹…åˆªé™¤æ­¤å–®</button>
                </div>`;
            }).join('');
        }
        async function updateOrderData(id, field, val) { const obj = {}; if(field==='booking_date'&&val) obj[field]=new Date(val).toISOString(); else obj[field]=val||null; await _s.from('orders').update(obj).eq('id', id); }
        async function toggleSync(id, cur) { await _s.from('orders').update({ status: cur==='synced'?'pending':'synced' }).eq('id', id); loadOrders(); }
        async function delOrder(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await _s.from('orders').delete().eq('id', id); loadOrders(); } }

        // --- 2. èœå–®ç¶­è­·æ ¸å¿ƒ (ç©©å®šç‰ˆé‚è¼¯) ---
        async function loadMenu() {
            const search = document.getElementById('menu-search').value.toLowerCase(), catF = document.getElementById('menu-cat-filter').value;
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            document.getElementById('menu-grid').innerHTML = (data || []).filter(i => i.name.toLowerCase().includes(search) && (catF==='all'||i.category_id===catF)).map(i => `<div class="bg-white rounded-3xl border p-4 shadow-sm flex flex-col h-full text-left"><div class="h-32 bg-stone-50 rounded-2xl mb-3 flex items-center justify-center overflow-hidden"><img src="${i.image_url||''}" class="max-h-full img-contain"></div><div class="flex justify-between font-bold text-sm"><span>${i.name}</span><span class="text-p-gold">$${i.price}</span></div><div class="flex gap-2 mt-auto pt-4"><button onclick="editItem('${i.id}')" class="flex-1 py-1 bg-stone-100 rounded text-xs font-bold shadow-sm">ç·¨è¼¯</button>${i.is_set_menu?`<button onclick="openSetModal('${i.id}')" class="flex-1 py-1 bg-amber-500 text-white rounded text-xs font-bold shadow-sm">å¥—é¤</button>`:''}<button onclick="delItem('${i.id}')" class="px-2 text-red-200">âœ•</button></div></div>`).join('');
        }
        async function saveItem() {
            const id = document.getElementById('m-id').value, file = document.getElementById('m-img').files[0]; let url = "";
            if(file) { const path = `items/${Date.now()}.png`; await _s.storage.from('assets').upload(path, file); url = _s.storage.from('assets').getPublicUrl(path).data.publicUrl; }
            const p = { name: document.getElementById('m-name').value, price: document.getElementById('m-price').value, description: document.getElementById('m-desc').value, category_id: document.getElementById('m-cat').value, is_set_menu: document.getElementById('m-is-set').checked }; if(url) p.image_url = url;
            const { data: saved } = id ? await _s.from('menu_items').update(p).eq('id', id).select() : await _s.from('menu_items').insert([p]).select();
            if (saved) { await _s.from('item_flavor_relation').delete().eq('item_id', saved[0].id); const rels = Array.from(document.querySelectorAll('.flv-chk:checked')).map(c => ({ item_id: saved[0].id, flavor_group_id: c.value })); if (rels.length) await _s.from('item_flavor_relation').insert(rels); closeMenuModal(); loadMenu(); }
        }

        // --- 3. å¥—é¤çµ„åˆ¥ç·¨è¼¯ (ä¿ç•™åŸæœ¬ç©©å®šé‚è¼¯) ---
        async function openSetModal(id) { curItem = id; resetSetForm(); document.getElementById('set-modal').classList.remove('hidden'); const { data } = await _s.from('menu_items').select('*, categories(name)').eq('is_set_menu', false).order('name'); window.allPickerItems = data || []; renderPickerList(data); loadSavedSets(); }
        function renderPickerList(items) { document.getElementById('item-picker-list').innerHTML = items.map(i => `<div onclick="togglePickerSelect('${i.id}', '${i.name}')" class="p-2 border rounded-xl bg-white text-[10px] font-bold text-left cursor-pointer text-left">${i.name}</div>`).join(''); }
        function togglePickerSelect(id, name) { if(!curPicks.some(p => p.id === id)) curPicks.push({id, name}); renderTempPicks(); }
        function renderTempPicks() { document.getElementById('temp-pick-display').innerHTML = curPicks.map((p, idx) => `<div class="bg-emerald-50 text-emerald-800 px-2 py-1 rounded text-[9px] font-bold text-left">${p.name} <span onclick="curPicks.splice(${idx},1);renderTempPicks();" class="cursor-pointer font-bold">âœ•</span></div>`).join(''); }
        async function editSetGroup(groupId) {
            currentEditingGroupId = groupId; const { data: g } = await _s.from('set_menu_groups').select('*, set_menu_contents(menu_items(*))').eq('id', groupId).single();
            if(g) { document.getElementById('g-name').value = g.group_name; document.getElementById('g-limit').value = g.selection_limit; document.getElementById('set-modal-title').innerText = "ç·¨è¼¯åˆ†çµ„"; document.getElementById('btn-save-group').innerText = "å„²å­˜æ›´æ–°"; curPicks = g.set_menu_contents.map(c => ({ id: c.menu_items.id, name: c.menu_items.name })); renderTempPicks(); }
        }
        async function saveFullSet() { 
            const n = document.getElementById('g-name').value, l = document.getElementById('g-limit').value; if(!n || !curPicks.length) return alert("ä¸é½Š");
            let gid = currentEditingGroupId;
            if(gid) { await _s.from('set_menu_groups').update({ group_name: n, selection_limit: l }).eq('id', gid); await _s.from('set_menu_contents').delete().eq('group_id', gid); }
            else { const { data } = await _s.from('set_menu_groups').insert([{ parent_set_id: curItem, group_name: n, selection_limit: l }]).select(); if(data) gid = data[0].id; }
            if(gid) { await _s.from('set_menu_contents').insert(curPicks.map(p => ({ group_id: gid, item_id: p.id }))); resetSetForm(); loadSavedSets(); }
        }
        async function loadSavedSets() { const { data } = await _s.from('set_menu_groups').select('*, set_menu_contents(menu_items(*))').eq('parent_set_id', curItem); document.getElementById('saved-groups-view').innerHTML = (data || []).map(g => `<div class="p-3 bg-stone-50 border rounded-xl flex justify-between mb-1 text-[10px] text-left text-left"><b>${g.group_name}</b><div class="flex gap-2"><button onclick="editSetGroup('${g.id}')" class="text-p-gold">ç·¨è¼¯</button><button onclick="delSetGroup('${g.id}')" class="text-red-400">âœ•</button></div></div>`).join(''); }
        async function delSetGroup(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { await _s.from('set_menu_groups').delete().eq('id', id); loadSavedSets(); } }
        function resetSetForm() { currentEditingGroupId = null; document.getElementById('g-name').value = ""; document.getElementById('g-limit').value = 1; curPicks = []; renderTempPicks(); document.getElementById('set-modal-title').innerText = "å¥—é¤åˆ†çµ„è¨­å®š"; document.getElementById('btn-save-group').innerText = "ç¢ºèªå„²å­˜"; }

        // --- åŸºç¤æ•¸æ“šèˆ‡ Logo ---
        async function loadCampaigns() { const { data } = await _s.from('campaign_settings').select('*').order('created_at', {ascending: false}); document.getElementById('campaign-list').innerHTML = (data || []).map(c => `<div class="flex justify-between p-3 bg-stone-50 border rounded-xl font-bold text-sm"><span>${c.code_name}</span><button onclick="delCampaign(${c.id})" class="text-red-400">âœ•</button></div>`).join(''); }
        async function loadCats() { const { data } = await _s.from('categories').select('*').order('sort_order'); document.getElementById('cat-list-table').innerHTML = data.map(c => `<tr class="border-b text-sm text-left"><td class="p-3">${c.sort_order}</td><td class="p-3 font-bold text-p-green text-left">${c.name}</td><td class="p-3 text-center"><input type="checkbox" ${c.is_visible?'checked':''} onchange="updateCatVis('${c.id}',this.checked)"></td><td class="p-3 text-center"><button onclick="delCat('${c.id}')" class="text-red-400">åˆªé™¤</button></td></tr>`).join(''); document.getElementById('m-cat').innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); document.getElementById('menu-cat-filter').innerHTML = '<option value="all">æ‰€æœ‰</option>' + data.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); }
        async function loadFlvs() { const { data } = await _s.from('flavor_groups').select('*, flavor_options(*)'); document.getElementById('flv-grid').innerHTML = (data || []).map(g => `<div class="bg-white p-5 rounded-2xl border flex justify-between shadow-sm"><b>ğŸŒ¶ï¸ ${g.name}</b><button onclick="delFlv('${g.id}')" class="text-red-400 text-xl font-serif">âœ•</button></div>`).join(''); }
        async function loadSettings() { const { data } = await _s.from('store_settings').select('*').eq('id', 1).single(); if(data?.logo_url) { const url = `${data.logo_url}?t=${Date.now()}`; document.getElementById('current-logo-preview').classList.remove('hidden'); document.getElementById('admin-logo-img').src = url; const sideImg = document.getElementById('side-logo-img'); if(sideImg) sideImg.src = url; } }
        async function uploadLogo() { const f = document.getElementById('logo-file').files[0]; if(!f) return; const path = `logo_${Date.now()}.png`; await _s.storage.from('assets').upload(path, f); const { data } = _s.storage.from('assets').getPublicUrl(path); await _s.from('store_settings').update({ logo_url: data.publicUrl }).eq('id', 1); loadSettings(); }

        // --- è¼”åŠ©å‡½å¼ ---
        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        function closeSetModal() { document.getElementById('set-modal').classList.add('hidden'); }
        function closeEditModal() { document.getElementById('order-edit-modal').classList.add('hidden'); }
        function closeEditPop() { document.getElementById('edit-flavor-popup').classList.add('hidden'); }
        function resetFilters() { document.getElementById('filter-search').value=''; loadOrders(); }
        function exportXls() { const ws = XLSX.utils.json_to_sheet(window.ordersRef); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "å ±è¡¨"); XLSX.writeFile(wb, "çœŸç å ±è¡¨.xlsx"); }

        // --- å•Ÿå‹• ---
        async function initialSetup() {
            await includeSidebar();
            switchTab('orders');
        }
        initialSetup();
    </script>
</body>
</html>
