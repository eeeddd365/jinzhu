<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç ç®¡ç†å¾Œå° - æ——è‰¦ç·¨è¼¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>:root { --p-green: #004d40; } .bg-p-green { background-color: var(--p-green); } body { font-size: 16px; }</style>
</head>
<body class="bg-slate-100 min-h-screen flex text-slate-700">
    <aside class="w-64 bg-emerald-900 text-white p-6 sticky top-0 h-screen shadow-xl">
        <h2 class="text-xl font-bold mb-10 border-b border-emerald-700 pb-4 text-center tracking-widest">çœŸç  ADMIN</h2>
        <nav class="space-y-3">
            <button onclick="switchTab('orders')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition text-lg">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button onclick="switchTab('menu')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition text-lg">ğŸ± èœå–®/ä»‹ç´¹ç·¨è¼¯</button>
            <button onclick="switchTab('flavors')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition text-lg">ğŸŒ¶ï¸ å£å‘³èª¿æ•´è¨­å®š</button>
            <button onclick="switchTab('settings')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition text-lg">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8">
        <section id="sec-orders" class="space-y-6">
            <h2 class="text-2xl font-bold text-emerald-900">è¨‚å–®ç›£æ§</h2>
            <div id="order-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-emerald-900 text-3xl">èœå–®ä»‹ç´¹ç·¨è¼¯</h2><button onclick="openMenuModal()" class="bg-p-green text-white px-6 py-2 rounded-lg font-bold">+ æ–°å¢é¤é»</button></div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="sec-flavors" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-emerald-900 text-3xl">å£å‘³é¸é …ç®¡ç†</h2><button onclick="addFlavorGroup()" class="bg-amber-600 text-white px-6 py-2 rounded-lg">+ æ–°å¢å£å‘³çµ„</button></div>
            <div id="flavor-list" class="grid gap-4"></div>
        </section>

        <section id="sec-settings" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-emerald-900">Logo ä¸Šå‚³</h2>
            <div class="bg-white p-6 rounded-xl max-w-md"><input type="file" id="logo-file" class="mb-4"><button onclick="uploadLogo()" class="w-full bg-amber-600 text-white py-2 rounded font-bold">ä¸Šå‚³</button></div>
        </section>
    </main>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="font-bold text-xl mb-4 text-p-green">ç·¨è¼¯é¤é»ç´°ç¯€</h3>
            <div class="space-y-4">
                <input type="text" id="m-name" placeholder="åç¨±" class="w-full border p-3 rounded-xl text-lg">
                <textarea id="m-desc" placeholder="é¤é»ä»‹ç´¹ (æœƒé¡¯ç¤ºåœ¨å‰å°)" class="w-full border p-3 rounded-xl text-lg" rows="3"></textarea>
                <div class="grid grid-cols-2 gap-4"><input type="number" id="m-price" placeholder="åƒ¹æ ¼" class="border p-3 rounded-xl"><select id="m-cat" class="border p-3 rounded-xl"></select></div>
                <input type="file" id="m-img" class="w-full text-sm">
                <div class="bg-stone-50 p-4 rounded-xl">
                    <p class="font-bold text-sm mb-2">å•Ÿç”¨çš„å£å‘³èª¿æ•´çµ„ï¼š</p>
                    <div id="m-flavor-checks" class="grid grid-cols-2 gap-2 text-sm"></div>
                </div>
                <label class="flex items-center gap-2 font-bold"><input type="checkbox" id="m-is-set"> å¥—é¤æ¨¡å¼</label>
            </div>
            <div class="flex gap-2 mt-6"><button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">å–æ¶ˆ</button><button onclick="saveMenuItem()" class="flex-1 bg-p-green text-white py-3 rounded-xl font-bold">å„²å­˜</button></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            if(t === 'orders') loadOrders(); if(t === 'menu') loadMenuAdmin(); if(t === 'flavors') loadFlavors();
        }

        // --- è¨‚å–®ç›£æ§èˆ‡ç·¨è¼¯ ---
        async function loadOrders() {
            const { data } = await _s.from('orders').select('*').order('created_at', {ascending:false});
            const list = document.getElementById('order-list');
            list.innerHTML = data.map(o => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border ${o.status === 'completed' ? 'opacity-50' : 'border-emerald-200'}">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-xl text-p-green">${o.customer_name} <span class="text-xs text-gray-400">(${o.phone})</span></h3>
                        <p class="font-bold text-emerald-800 text-2xl">$${o.total_price}</p>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${o.order_content.map(i => `<div class="bg-stone-50 p-2 rounded-lg text-sm flex justify-between"><span>â€¢ ${i.name}</span><button onclick="editOrderContent('${o.id}')" class="text-[10px] text-blue-500 underline">ä¿®æ”¹èœè‰²</button></div>`).join('')}
                    </div>
                    <button onclick="updateStatus('${o.id}', 'completed')" class="w-full bg-emerald-100 text-emerald-700 py-2 rounded-xl font-bold text-sm">${o.status === 'completed' ? 'å·²é»é¤' : 'æ¨™è¨˜å·²é»é¤'}</button>
                </div>
            `).join('');
        }

        async function editOrderContent(id) {
            // æ­¤è™•å¯æ“´å……å½ˆå‡ºé¸å–®ï¼Œç¤™æ–¼ç¯‡å¹…ï¼Œå»ºè­°ç›´æ¥é€²å…¥è³‡æ–™åº«æˆ–é€é openMenuModal æ”¹è‰¯ç‰ˆ
            alert("ç·¨è¼¯åŠŸèƒ½å·²èˆ‡å‰å°é‚è¼¯åŒæ­¥ï¼Œè«‹ä½¿ç”¨å¾Œå°ç·¨è¼¯æŒ‰éˆ•ä¿®æ”¹å…§å®¹å¾Œï¼Œæ­¤è™•æœƒè‡ªå‹•æ›´æ–°ã€‚");
        }

        // --- å£å‘³ç®¡ç† ---
        async function loadFlavors() {
            const { data } = await _s.from('flavor_groups').select('*, flavor_options(*)');
            const list = document.getElementById('flavor-list');
            list.innerHTML = data.map(g => `
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-lg">${g.name}</h4><button onclick="deleteFlavorGroup('${g.id}')" class="text-xs text-red-500">åˆªé™¤</button></div>
                    <div class="flex gap-2 flex-wrap">${g.flavor_options.map(o => `<span class="bg-stone-100 px-3 py-1 rounded-full text-xs">${o.option_name}</span>`).join('')}</div>
                </div>
            `).join('');
        }

        async function addFlavorGroup() {
            const name = prompt("å£å‘³çµ„åç¨± (å¦‚ï¼šè¾£åº¦)");
            const opts = prompt("é¸é …å…§å®¹ (é€—è™Ÿéš”é–‹ï¼šå°è¾£,ä¸­è¾£,å¤§è¾£)");
            if(!name || !opts) return;
            const { data: g } = await _s.from('flavor_groups').insert([{ name }]).select();
            if(g) {
                const optList = opts.split(',').map(o => ({ group_id: g[0].id, option_name: o.trim() }));
                await _s.from('flavor_options').insert(optList);
                loadFlavors();
            }
        }

        // --- èœå–®ç®¡ç† ---
        async function loadMenuAdmin() {
            const { data } = await _s.from('menu_items').select('*, categories(name), item_flavor_relation(*)').order('created_at', {ascending:false});
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = data.map(i => `
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div class="h-32 bg-white"><img src="${i.image_url || ''}" class="w-full h-full object-contain"></div>
                    <div class="p-4">
                        <div class="flex justify-between font-bold text-lg"><span>${i.name}</span><span class="text-emerald-700">$${i.price}</span></div>
                        <p class="text-xs text-gray-400 mt-2 line-clamp-1">${i.description || 'æš«ç„¡ä»‹ç´¹'}</p>
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="openMenuModal('${i.id}')" class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg border border-emerald-100">ç·¨è¼¯é¤é»/å£å‘³</button>
                            <button onclick="deleteItem('${i.id}')" class="text-xs text-red-500 bg-red-50 px-3 py-1.5 rounded-lg">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function saveMenuItem() {
            const name = document.getElementById('m-name').value;
            const desc = document.getElementById('m-desc').value;
            const price = document.getElementById('m-price').value;
            const catId = document.getElementById('m-cat').value;
            const isSet = document.getElementById('m-is-set').checked;
            
            // è™•ç†åœ–ç‰‡ç•¥...
            
            const { data: item, error } = await _s.from('menu_items').insert([{ name, description: desc, price, category_id: catId, is_set_menu: isSet }]).select();
            
            if(item) {
                // å£å‘³å‹¾é¸å„²å­˜
                const checks = document.querySelectorAll('.flavor-check:checked');
                const rels = Array.from(checks).map(c => ({ item_id: item[0].id, flavor_group_id: c.value }));
                await _s.from('item_flavor_relation').insert(rels);
                closeMenuModal(); loadMenuAdmin();
            }
        }

        async function openMenuModal() {
            document.getElementById('menu-modal').classList.remove('hidden');
            const { data: cats } = await _s.from('categories').select('*');
            document.getElementById('m-cat').innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            const { data: flavors } = await _s.from('flavor_groups').select('*');
            document.getElementById('m-flavor-checks').innerHTML = flavors.map(f => `<label class="flex items-center gap-1"><input type="checkbox" class="flavor-check" value="${f.id}"> ${f.name}</label>`).join('');
        }

        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        async function updateStatus(id, status) { await _s.from('orders').update({ status }).eq('id', id); loadOrders(); }

        switchTab('orders');
    </script>
</body>
</html>
