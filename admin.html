<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç  ADMIN - å…¨åŠŸèƒ½ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>:root { --p-green: #004d40; } .bg-p-green { background-color: var(--p-green); }</style>
</head>
<body class="bg-slate-100 flex min-h-screen">
    <aside class="w-64 bg-emerald-900 text-white p-6 sticky top-0 h-screen shadow-xl">
        <h2 class="text-xl font-bold mb-10 border-b border-emerald-700 pb-4 text-center tracking-widest">çœŸç  POS åŒæ­¥</h2>
        <nav class="space-y-3">
            <button onclick="switchTab('orders')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button onclick="switchTab('categories')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ—‚ï¸ åˆ†é¡ç®¡ç†</button>
            <button onclick="switchTab('menu')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ± èœå–®/ä»‹ç´¹/å®¢è£½</button>
            <button onclick="switchTab('flavors')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸŒ¶ï¸ å®¢è£½åŒ–é¸é …</button>
            <button onclick="switchTab('settings')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">âš™ï¸ Logo è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <section id="sec-orders" class="space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">å³æ™‚è¨‚å–®å¡ç‰‡</h2><button onclick="exportXls()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg">ğŸ“Š å°å‡ºå ±è¡¨</button></div>
            <div id="order-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">èœå–®ç®¡ç†</h2><button onclick="openMenuModal()" class="bg-p-green text-white px-6 py-2 rounded-lg shadow-lg">+ æ–°å¢èœè‰²/å¥—é¤</button></div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="sec-categories" class="hidden space-y-6">
            <h2 class="text-2xl font-bold">åˆ†é¡ç·¨è¼¯</h2>
            <div class="bg-white p-4 rounded-xl shadow max-w-sm"><div class="flex gap-2 mb-4"><input id="new-cat" class="border p-2 flex-1"><button onclick="addCat()" class="bg-p-green text-white px-4 rounded">æ–°å¢</button></div><div id="cat-list" class="space-y-2"></div></div>
        </section>
        
        <section id="sec-flavors" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">å®¢è£½åŒ–å£å‘³å®šç¾©</h2><button onclick="addFlvGroup()" class="bg-amber-600 text-white px-4 py-2 rounded-lg">æ–°å¢é¸é …çµ„</button></div>
            <div id="flv-grid" class="grid gap-4"></div>
        </section>
    </main>

    <div id="set-edit-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="font-bold text-xl mb-6 text-p-green border-b pb-2">å¥—é¤çµ„åˆé…å°</h3>
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-2"><input id="g-name" placeholder="çµ„å(å¦‚:ä¸»é£Ÿé¸ä¸€)" class="border p-2 rounded"><input id="g-limit" type="number" placeholder="å¿…é¸æ•¸" class="border p-2 rounded"></div>
                <div class="bg-stone-50 p-4 rounded-xl">
                    <p class="text-xs font-bold mb-2">å¾ç¾æœ‰èœè‰²ä¸­é¸æ“‡åŠ å…¥æ­¤çµ„ï¼š</p>
                    <select id="item-picker" class="w-full border p-2 mb-2 rounded"></select>
                    <button onclick="addPick()" class="w-full bg-amber-500 text-white py-2 rounded text-sm">åŠ å…¥æ­¤çµ„é¸é …</button>
                    <div id="pick-list" class="mt-4 space-y-1"></div>
                </div>
                <button onclick="saveFullSet()" class="w-full bg-p-green text-white py-4 rounded-xl font-bold">ç¢ºèªå„²å­˜æ­¤å¥—é¤çµ„åˆ</button>
            </div>
            <button onclick="closeSetModal()" class="mt-4 text-gray-400 w-full underline text-center">è¿”å›</button>
        </div>
    </div>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
            <h3 class="font-bold text-xl mb-4">èœè‰²åŸºæœ¬è¨­å®š</h3>
            <input type="hidden" id="m-id">
            <div class="space-y-4">
                <input id="m-name" placeholder="èœå" class="w-full border p-3 rounded-xl">
                <textarea id="m-desc" placeholder="ä»‹ç´¹" class="w-full border p-3 rounded-xl"></textarea>
                <div class="grid grid-cols-2 gap-4"><input id="m-price" type="number" placeholder="å–®é»åƒ¹æ ¼" class="border p-3 rounded-xl"><select id="m-cat" class="border p-3 rounded-xl"></select></div>
                <div class="bg-stone-50 p-3 rounded-xl">
                    <p class="text-[10px] font-bold text-gray-400 mb-2">æ˜¯å¦é–‹å•Ÿå®¢è£½åŒ–é¸é …ï¼š</p>
                    <div id="flv-checks" class="grid grid-cols-2 gap-2 text-xs"></div>
                </div>
                <div><label class="block text-xs font-bold mb-1">ä¸Šå‚³åœ–ç‰‡</label><input type="file" id="m-img" class="w-full text-xs"></div>
                <label class="flex items-center gap-2 p-2 bg-emerald-50 rounded-lg cursor-pointer font-bold"><input type="checkbox" id="m-is-set"> æ­¤ç‚ºå¥—é¤ (å‹¾é¸å¾Œæ‰å¯é€²å…¥å¥—é¤çµ„åˆé…å°)</label>
            </div>
            <div class="flex gap-2 mt-8"><button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-3 rounded-xl">å–æ¶ˆ</button><button onclick="saveItem()" class="flex-1 bg-p-green text-white py-3 rounded-xl">å„²å­˜åŸºæœ¬è³‡è¨Š</button></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let curItem = null, picks = [];

        function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            if(t==='orders') loadOrders(); if(t==='menu') loadMenu(); if(t==='categories') loadCats(); if(t==='flavors') loadFlvs();
        }

        async function loadOrders() {
            const { data } = await _s.from('orders').select('*').order('created_at', {ascending:false});
            document.getElementById('order-list').innerHTML = data.map(o => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border ${o.status==='synced'?'opacity-50 grayscale':''}">
                    <div class="flex justify-between font-bold text-lg mb-4"><span>${o.customer_name}</span><span>$${o.total_price}</span></div>
                    <div class="space-y-1 mb-4 text-sm text-gray-500">${o.order_content.map(i => `<div class="flex justify-between"><span>â€¢ ${i.name}</span><button onclick="editOrder('${o.id}')" class="text-blue-500 text-[10px]">ä¿®æ”¹</button></div>`).join('')}</div>
                    <button onclick="syncPOS('${o.id}')" class="w-full py-2 rounded-xl text-xs font-bold border-2 ${o.status==='synced'?'bg-stone-100 border-stone-200 text-stone-400':'border-p-green text-p-green'}">${o.status==='synced'?'å·²åŒæ­¥ POS':'æ¨™è¨˜å·²å®ŒæˆåŒæ­¥'}</button>
                </div>`).join('');
            window.allOrders = data;
        }

        async function loadMenu() {
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            document.getElementById('menu-grid').innerHTML = data.map(i => `
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden p-4">
                    <img src="${i.image_url || ''}" class="w-full h-32 object-contain mb-2">
                    <div class="font-bold mb-2">${i.name} ($${i.price})</div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="editItem('${i.id}')" class="text-[10px] bg-stone-100 px-2 py-1 rounded">ç·¨è¼¯</button>
                        ${i.is_set_menu ? `<button onclick="openSetModal('${i.id}')" class="text-[10px] bg-amber-500 text-white px-2 py-1 rounded shadow-sm">æ­é…å¥—é¤çµ„åˆ</button>` : ''}
                        <button onclick="deleteItem('${i.id}')" class="text-[10px] text-red-500">åˆªé™¤</button>
                    </div>
                </div>`).join('');
        }

        async function openSetModal(id) {
            curItem = id; picks = [];
            document.getElementById('set-edit-modal').classList.remove('hidden');
            const { data } = await _s.from('menu_items').select('*').eq('is_set_menu', false);
            document.getElementById('item-picker').innerHTML = data.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            loadPicks();
        }

        async function loadPicks() {
            const { data } = await _s.from('set_menu_groups').select('*, set_menu_contents(menu_items(*))').eq('parent_set_id', curItem);
            document.getElementById('pick-list').innerHTML = data.map(g => `
                <div class="p-2 border rounded-lg bg-white text-[10px] shadow-sm mb-2">
                    <div class="flex justify-between font-bold"><span>${g.group_name}</span><button onclick="deleteGroup('${g.id}')" class="text-red-500 underline">åˆªé™¤</button></div>
                    <div class="text-gray-400">${g.set_menu_contents.map(c => c.menu_items.name).join(', ')}</div>
                </div>`).join('');
        }

        function addPick() {
            const el = document.getElementById('item-picker');
            picks.push({ id: el.value, name: el.options[el.selectedIndex].text });
            document.getElementById('pick-list').innerHTML += `<div class="text-[10px] bg-emerald-50 p-1 border">â— ${el.options[el.selectedIndex].text}</div>`;
        }

        async function saveFullSet() {
            const { data: g } = await _s.from('set_menu_groups').insert([{ parent_set_id: curItem, group_name: document.getElementById('g-name').value, selection_limit: document.getElementById('g-limit').value }]).select();
            if(g) {
                await _s.from('set_menu_contents').insert(picks.map(p => ({ group_id: g[0].id, item_id: p.id })));
                alert("æ­¤çµ„åˆå·²åŠ å…¥å¥—é¤ï¼"); loadPicks(); picks = [];
            }
        }

        // --- åŸºæœ¬ä¿å­˜é‚è¼¯ ---
        async function saveItem() {
            const id = document.getElementById('m-id').value;
            const file = document.getElementById('m-img').files[0];
            let url = "";
            if(file) {
                const path = `items/${Date.now()}.png`;
                await _s.storage.from('assets').upload(path, file);
                url = `${SUPABASE_URL}/storage/v1/object/public/assets/${path}`;
            }

            const p = { name: document.getElementById('m-name').value, price: document.getElementById('m-price').value, description: document.getElementById('m-desc').value, category_id: document.getElementById('m-cat').value, is_set_menu: document.getElementById('m-is-set').checked };
            if(url) p.image_url = url;

            const { data: saved } = id ? await _s.from('menu_items').update(p).eq('id', id).select() : await _s.from('menu_items').insert([p]).select();
            if(saved) {
                await _s.from('item_flavor_relation').delete().eq('item_id', saved[0].id);
                const rels = Array.from(document.querySelectorAll('.flv-chk:checked')).map(c => ({ item_id: saved[0].id, flavor_group_id: c.value }));
                await _s.from('item_flavor_relation').insert(rels);
                closeMenuModal(); loadMenu();
            }
        }

        async function openMenuModal() {
            document.getElementById('menu-modal').classList.remove('hidden');
            const { data: cats } = await _s.from('categories').select('*');
            document.getElementById('m-cat').innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const { data: flvs } = await _s.from('flavor_groups').select('*');
            document.getElementById('flv-checks').innerHTML = flvs.map(f => `<label class="flex items-center gap-1"><input type="checkbox" class="flv-chk" value="${f.id}"> ${f.name}</label>`).join('');
        }

        // Excel, Sync, Logo ä¸Šå‚³é‚è¼¯ä¿æŒç°¡æ½”æœ‰æ•ˆ
        function exportXls() {
            const ws = XLSX.utils.json_to_sheet(window.allOrders.map(o => ({ æ™‚é–“: new Date(o.created_at).toLocaleString(), å®¢æˆ¶: o.customer_name, é›»è©±: o.phone, é‡‘é¡: o.total_price, å…§å®¹: o.order_content.map(i=>i.name).join('; ') })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Orders");
            XLSX.writeFile(wb, `çœŸç å ±è¡¨_${new Date().toLocaleDateString()}.xlsx`);
        }
        async function syncPOS(id) { await _s.from('orders').update({ status: 'synced' }).eq('id', id); loadOrders(); }
        async function uploadLogo() { const file = document.getElementById('logo-file').files[0]; const p = `logo_${Date.now()}.png`; await _s.storage.from('assets').upload(p, file); const url = `${SUPABASE_URL}/storage/v1/object/public/assets/${p}`; await _s.from('store_settings').update({ logo_url: url }).eq('id',1); alert("Logo æ›´æ–°"); }
        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        function closeSetModal() { document.getElementById('set-edit-modal').classList.add('hidden'); }
        
        switchTab('orders');
    </script>
</body>
</html>
