<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç ç®¡ç†å¾Œå° - æ——è‰¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen flex">
    <aside class="w-64 bg-emerald-900 text-white p-6 sticky top-0 h-screen">
        <h2 class="text-xl font-bold mb-8 tracking-widest text-center border-b border-emerald-700 pb-4">çœŸç  ADMIN</h2>
        <nav class="space-y-2">
            <button onclick="switchTab('orders')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸ“‹ è¨‚å–®ç®¡ç†</button>
            <button onclick="switchTab('menu')" class="w-full text-left p-3 rounded hover:bg-emerald-800">ğŸ± èœå–®/ä»‹ç´¹ç·¨è¼¯</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <section id="sec-orders">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-emerald-900">è¨‚å–®ç®¡ç†</h2>
                <button onclick="exportToExcel()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow">ğŸ“Š å°å‡º Excel</button>
            </div>
            <div id="order-list" class="grid gap-4"></div>
        </section>

        <section id="sec-menu" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-emerald-900">é¤é»èˆ‡ä»‹ç´¹ç·¨è¼¯</h2>
                <button onclick="openMenuModal()" class="bg-emerald-700 text-white px-6 py-2 rounded-lg">+ æ–°å¢é¤é»</button>
            </div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
    </main>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-2xl overflow-hidden p-6 shadow-2xl">
            <h3 class="font-bold text-xl mb-4">ç·¨è¼¯é¤é»è³‡è¨Š</h3>
            <div class="space-y-3">
                <input type="text" id="m-name" placeholder="é¤é»/å¥—é¤åç¨±" class="w-full border p-3 rounded-xl">
                <textarea id="m-desc" placeholder="é¤é»ä»‹ç´¹ (æœƒé¡¯ç¤ºåœ¨å‰å°è©³æƒ…)" rows="3" class="w-full border p-3 rounded-xl"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="m-price" placeholder="åƒ¹æ ¼" class="w-full border p-3 rounded-xl">
                    <select id="m-cat" class="w-full border p-3 rounded-xl"></select>
                </div>
                <input type="file" id="m-img" class="w-full text-sm">
                <label class="flex items-center gap-2 font-bold"><input type="checkbox" id="m-is-set"> å¥—é¤æ¨¡å¼</label>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeMenuModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                <button onclick="saveMenuItem()" class="flex-1 py-3 bg-emerald-700 text-white rounded-xl font-bold">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function switchTab(t) {
            document.getElementById('sec-orders').classList.toggle('hidden', t !== 'orders');
            document.getElementById('sec-menu').classList.toggle('hidden', t !== 'menu');
            if(t === 'orders') loadOrders(); else loadMenu();
        }

        async function loadOrders() {
            const { data } = await _s.from('orders').select('*').order('created_at', {ascending:false});
            const list = document.getElementById('order-list');
            list.innerHTML = data.map(o => `
                <div class="bg-white p-5 rounded-xl shadow-sm border ${o.status === 'completed' ? 'opacity-50 border-gray-200' : 'border-emerald-100'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs px-2 py-1 rounded ${o.status === 'completed' ? 'bg-gray-400' : 'bg-emerald-600'} text-white font-bold">${o.status === 'completed' ? 'å·²å®Œæˆ' : 'è™•ç†ä¸­'}</span>
                            <h3 class="font-bold text-lg mt-1">${o.customer_name} (${o.adults}å¤§${o.kids_chair}å…’ç«¥${o.toddlers}å­©ç«¥)</h3>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-emerald-800">$${o.total_price}</p>
                            ${o.status === 'pending' ? `<button onclick="updateStatus('${o.id}', 'completed')" class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold mt-2">æ¨™è¨˜å®Œæˆ</button>` : ''}
                        </div>
                    </div>
                    <div class="mt-3 text-sm text-gray-500">${o.order_content.map(i => `â€¢ ${i.name}`).join('<br>')}</div>
                </div>
            `).join('');
            window.allOrders = data;
        }

        async function updateStatus(id, status) {
            await _s.from('orders').update({ status }).eq('id', id);
            loadOrders();
        }

        function exportToExcel() {
            const worksheet = XLSX.utils.json_to_sheet(window.allOrders.map(o => ({
                'è¨‚è³¼æ™‚é–“': new Date(o.created_at).toLocaleString(),
                'å®¢æˆ¶å§“å': o.customer_name,
                'é›»è©±': o.phone,
                'äººæ•¸': `${o.adults}å¤§${o.kids_chair}ç«¥${o.toddlers}å­©`,
                'ç¸½é‡‘é¡': o.total_price,
                'è¨‚å–®å…§å®¹': o.order_content.map(i => i.name).join(', '),
                'ç‹€æ…‹': o.status === 'pending' ? 'å¾…è™•ç†' : 'å·²å®Œæˆ'
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Orders");
            XLSX.writeFile(workbook, `çœŸç è¨‚å–®å ±è¡¨_${new Date().toLocaleDateString()}.xlsx`);
        }

        async function loadMenu() {
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = data.map(i => `
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <img src="${i.image_url || 'https://via.placeholder.com/300'}" class="w-full h-32 object-cover">
                    <div class="p-4">
                        <div class="flex justify-between font-bold"><span>${i.name}</span><span class="text-emerald-700">$${i.price}</span></div>
                        <p class="text-xs text-gray-400 mt-2 line-clamp-2">${i.description || 'æš«ç„¡ä»‹ç´¹'}</p>
                        <div class="mt-4 flex gap-2">
                            <button onclick="deleteItem('${i.id}')" class="text-xs text-red-500 border px-3 py-1 rounded">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function saveMenuItem() {
            const name = document.getElementById('m-name').value;
            const desc = document.getElementById('m-desc').value;
            const price = document.getElementById('m-price').value;
            const catId = document.getElementById('m-cat').value;
            const isSet = document.getElementById('m-is-set').checked;
            const file = document.getElementById('m-img').files[0];

            let imgUrl = "";
            if(file) {
                const path = `items/${Date.now()}.png`;
                await _s.storage.from('assets').upload(path, file);
                imgUrl = `${SUPABASE_URL}/storage/v1/object/public/assets/${path}`;
            }

            const { error } = await _s.from('menu_items').insert([{
                name, description: desc, price, category_id: catId, is_set_menu: isSet, image_url: imgUrl
            }]);
            if(!error) { closeMenuModal(); loadMenu(); }
        }

        function openMenuModal() { 
            document.getElementById('menu-modal').classList.remove('hidden');
            _s.from('categories').select('*').then(({data}) => {
                document.getElementById('m-cat').innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            });
        }
        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        async function deleteItem(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await _s.from('menu_items').delete().eq('id', id); loadMenu(); } }

        switchTab('orders');
    </script>
</body>
</html>
