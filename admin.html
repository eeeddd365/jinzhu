<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç ç®¡ç†å¾Œå° - å°ˆæ¥­ç·¨è¼¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; }
        .bg-p-green { background-color: var(--p-green); }
        .text-p-green { color: var(--p-green); }
        .border-p-gold { border-color: var(--p-gold); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex text-slate-700">

    <aside class="w-64 bg-emerald-900 text-white p-6 flex flex-col shadow-xl sticky top-0 h-screen">
        <h2 class="text-xl font-bold mb-10 tracking-widest border-b border-emerald-700 pb-4 text-center">çœŸç  ADMIN</h2>
        <nav class="space-y-2 flex-1">
            <button onclick="switchTab('orders')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button onclick="switchTab('menu')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ± èœå–®/å¥—é¤ç®¡ç†</button>
            <button onclick="switchTab('categories')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ—‚ï¸ åˆ†é¡è¨­å®š</button>
            <button onclick="switchTab('settings')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        
        <section id="sec-orders" class="space-y-6">
            <h2 class="text-2xl font-bold text-p-green">å³æ™‚è¨‚å–®ç‹€æ³</h2>
            <div id="order-list" class="grid gap-4"></div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-p-green">é¤é»ç®¡ç†</h2>
                <button onclick="openMenuModal()" class="bg-p-green text-white px-6 py-2 rounded-full shadow-lg hover:bg-emerald-800 transition">+ æ–°å¢é¤é»</button>
            </div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="sec-categories" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-p-green">åˆ†é¡ç®¡ç†</h2>
            <div class="bg-white p-6 rounded-xl shadow-sm max-w-md border border-slate-200">
                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-cat-name" placeholder="åˆ†é¡åç¨±" class="flex-1 border p-2 rounded-lg outline-none focus:ring-1 focus:ring-p-green">
                    <button onclick="addCategory()" class="bg-p-green text-white px-4 py-2 rounded-lg">æ–°å¢</button>
                </div>
                <div id="cat-list" class="space-y-2"></div>
            </div>
        </section>

        <section id="sec-settings" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-p-green">ç³»çµ±è¨­å®š</h2>
            <div class="bg-white p-6 rounded-xl shadow-sm max-w-md border border-slate-200">
                <label class="block font-bold mb-2">æ›´æ–°é¤å»³ Logo</label>
                <input type="file" id="logo-file" accept="image/*" class="w-full text-sm mb-4">
                <button onclick="uploadLogo()" class="bg-p-gold text-white px-6 py-2 rounded-lg w-full font-bold">åŸ·è¡Œä¸Šå‚³ Logo</button>
                <div id="logo-preview-area" class="mt-6 border-t pt-4 hidden">
                    <p class="text-xs text-gray-400 mb-2">ç›®å‰ Logo é è¦½ï¼š</p>
                    <img id="admin-preview-logo" src="" class="h-20 object-contain mx-auto">
                </div>
            </div>
        </section>

    </main>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden overflow-y-auto max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-stone-50">
                <h3 class="font-bold text-lg text-p-green">æ–°å¢/ç·¨è¼¯é¤é»</h3>
                <button onclick="closeMenuModal()" class="text-2xl text-gray-400 hover:text-black">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="text" id="m-name" placeholder="é¤é»åç¨±" class="w-full border p-3 rounded-xl outline-none focus:ring-1 focus:ring-p-green">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="m-price" placeholder="åƒ¹æ ¼" class="w-full border p-3 rounded-xl outline-none focus:ring-1 focus:ring-p-green">
                    <select id="m-cat" class="w-full border p-3 rounded-xl outline-none focus:ring-1 focus:ring-p-green"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">é¤é»ç…§ç‰‡</label>
                    <input type="file" id="m-img" accept="image/*" class="w-full text-sm border p-2 rounded-xl">
                </div>
                <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                    <label class="flex items-center gap-2 font-bold text-amber-900 cursor-pointer">
                        <input type="checkbox" id="m-is-set" class="w-5 h-5 accent-amber-600"> é€™æ˜¯ä¸€å€‹ã€Œå¤šé¸å¥—é¤ã€
                    </label>
                    <p class="text-[10px] text-amber-700 mt-1 italic">è‹¥å‹¾é¸å¥—é¤ï¼Œè«‹åœ¨å„²å­˜å¾Œé»æ“Šåˆ—è¡¨çš„ã€Œâš™ï¸ è¨­å®šåˆ†çµ„ã€ä¾†åŠ å…¥é¸æ“‡ç´°é …ã€‚</p>
                </div>
            </div>
            <div class="p-6 border-t bg-stone-50 flex gap-3">
                <button onclick="closeMenuModal()" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold">å–æ¶ˆ</button>
                <button onclick="saveMenuItem()" class="flex-1 py-3 bg-p-green text-white rounded-xl font-bold shadow-md">å„²å­˜é¤é»</button>
            </div>
        </div>
    </div>

    <div id="group-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[110] p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-p-green text-white">
                <div>
                    <h3 class="font-bold text-xl">è¨­å®šå¥—é¤åˆ†çµ„ç´°é …</h3>
                    <p id="group-target-name" class="text-xs opacity-70 mt-1"></p>
                </div>
                <button onclick="closeGroupModal()" class="text-3xl">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label class="block text-sm font-bold mb-2">åˆ†çµ„åç¨± (ä¾‹å¦‚: å‰èœã€ä¸»é¤)</label>
                        <input type="text" id="g-name" placeholder="è¼¸å…¥åç¨±" class="w-full border-2 p-3 rounded-xl focus:border-p-gold outline-none">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-bold mb-2">å¯é¸æ•¸é‡ä¸Šé™</label>
                        <input type="number" id="g-limit" value="1" class="w-full border-2 p-3 rounded-xl focus:border-p-gold outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">é¸é …å…§å®¹ (è«‹ç”¨åŠå½¢é€—è™Ÿéš”é–‹)</label>
                    <textarea id="g-options" rows="4" placeholder="ä¾‹å¦‚: ç´…èŒ¶, ç¶ èŒ¶, çƒæ¢…æ±" class="w-full border-2 p-3 rounded-xl focus:border-p-gold outline-none"></textarea>
                    <p class="text-[10px] text-gray-400 mt-2">æç¤ºï¼šæ¯å€‹é¸é …ä¹‹é–“è«‹ç”¨ã€Œ,ã€éš”é–‹ï¼Œç³»çµ±æœƒè‡ªå‹•æ‹†åˆ†ã€‚</p>
                </div>
                <div id="existing-groups" class="pt-6 border-t">
                    <h4 class="font-bold text-sm text-p-green mb-3">å·²è¨­å®šçš„åˆ†çµ„æ¸…å–®ï¼š</h4>
                    <div id="group-list-container" class="space-y-2">
                        </div>
                </div>
            </div>
            <div class="p-6 border-t bg-stone-50 flex gap-4">
                <button onclick="closeGroupModal()" class="px-6 py-3 text-gray-500 font-bold">é—œé–‰</button>
                <button onclick="saveGroup()" class="flex-1 py-3 bg-p-gold text-white rounded-xl font-bold shadow-lg">æ–°å¢/å„²å­˜æ­¤çµ„åˆ¥</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentEditingItemId = null;

        function switchTab(tab) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${tab}`).classList.remove('hidden');
            if(tab === 'orders') loadOrders();
            if(tab === 'menu') loadMenuAdmin();
            if(tab === 'categories') loadCategoriesAdmin();
            if(tab === 'settings') loadSettingsAdmin();
        }

        // --- è¨‚å–® ---
        async function loadOrders() {
            const { data } = await _s.from('orders').select('*').order('created_at', {ascending:false});
            const container = document.getElementById('order-list');
            container.innerHTML = data.map(o => `
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="bg-emerald-100 text-emerald-800 text-[10px] px-2 py-1 rounded font-bold mb-1 inline-block">æ–°è¨‚å–®</span>
                            <h3 class="font-bold text-lg text-slate-800">${o.customer_name} <span class="text-sm font-normal text-slate-400">(${o.adults}å¤§ / ${o.kids_chair}å…’ç«¥ / ${o.toddlers}å­©ç«¥)</span></h3>
                        </div>
                        <div class="text-right"><p class="font-bold text-p-green">$${o.total_price}</p></div>
                    </div>
                    <div class="bg-stone-50 p-4 rounded-xl text-sm text-slate-600 leading-relaxed">
                        ${o.order_content.map(i => `â€¢ ${i.name}`).join('<br>')}
                    </div>
                </div>
            `).join('');
        }

        // --- èœå–®ç®¡ç† ---
        async function loadMenuAdmin() {
            const { data: items } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = items.map(i => `
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
                    <img src="${i.image_url || 'https://via.placeholder.com/300x150?text=Pearl'}" class="w-full h-36 object-cover bg-slate-100">
                    <div class="p-5">
                        <div class="flex justify-between font-bold mb-1 text-slate-800">
                            <span>${i.name}</span>
                            <span class="text-p-green">$${i.price}</span>
                        </div>
                        <p class="text-[10px] text-slate-400 mb-4">åˆ†é¡ï¼š${i.categories?.name || 'æœªåˆ†é¡'}</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="toggleHide('${i.id}', ${i.is_hidden})" class="text-[10px] bg-slate-100 px-3 py-1.5 rounded-lg">${i.is_hidden ? 'ğŸ‘ï¸ é¡¯ç¤º' : 'ğŸš« éš±è—'}</button>
                            ${i.is_set_menu ? `<button onclick="openGroupModal('${i.id}', '${i.name}')" class="text-[10px] bg-amber-500 text-white px-3 py-1.5 rounded-lg font-bold">âš™ï¸ è¨­å®šåˆ†çµ„</button>` : ''}
                            <button onclick="deleteItem('${i.id}')" class="text-[10px] bg-red-50 text-red-500 px-3 py-1.5 rounded-lg">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- åˆ†çµ„ç·¨è¼¯å½ˆçª—é‚è¼¯ ---
        async function openGroupModal(itemId, itemName) {
            currentEditingItemId = itemId;
            document.getElementById('group-target-name').innerText = `æ­£åœ¨ç‚ºã€Œ${itemName}ã€ç·¨è¼¯å¥—é¤é¸é …`;
            document.getElementById('group-modal').classList.remove('hidden');
            loadExistingGroups();
        }

        async function loadExistingGroups() {
            const { data: groups } = await _s.from('set_menu_groups').select('*, set_menu_options(*)').eq('menu_item_id', currentEditingItemId);
            const container = document.getElementById('group-list-container');
            if(groups.length === 0) {
                container.innerHTML = `<p class="text-xs text-gray-400 italic">å°šæœªå»ºç«‹ä»»ä½•åˆ†çµ„...</p>`;
            } else {
                container.innerHTML = groups.map(g => `
                    <div class="bg-stone-50 p-4 rounded-xl flex justify-between items-center border border-stone-200">
                        <div>
                            <span class="font-bold text-sm">${g.group_name} (é™ ${g.selection_limit} é …)</span>
                            <p class="text-[10px] text-gray-400 mt-1">${g.set_menu_options.map(o => o.option_name).join(', ')}</p>
                        </div>
                        <button onclick="deleteGroup('${g.id}')" class="text-red-500 text-xs font-bold">åˆªé™¤çµ„åˆ¥</button>
                    </div>
                `).join('');
            }
        }

        async function saveGroup() {
            const gName = document.getElementById('g-name').value;
            const limit = document.getElementById('g-limit').value;
            const optionsRaw = document.getElementById('g-options').value;

            if(!gName || !optionsRaw) return alert("è«‹å¡«å…¥çµ„åˆ¥åç¨±èˆ‡é¸é …");

            const { data: gData, error: gError } = await _s.from('set_menu_groups').insert([{
                menu_item_id: currentEditingItemId, group_name: gName, selection_limit: parseInt(limit)
            }]).select();

            if(!gError) {
                const optList = optionsRaw.split(',').map(o => ({ group_id: gData[0].id, option_name: o.trim() }));
                await _s.from('set_menu_options').insert(optList);
                
                // æ¸…ç©ºè¼¸å…¥
                document.getElementById('g-name').value = '';
                document.getElementById('g-limit').value = '1';
                document.getElementById('g-options').value = '';
                
                loadExistingGroups();
                alert("åˆ†çµ„å„²å­˜æˆåŠŸï¼");
            }
        }

        async function deleteGroup(gid) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤åˆ†çµ„åŠå…¶æ‰€æœ‰é¸é …ï¼Ÿ")) return;
            await _s.from('set_menu_groups').delete().eq('id', gid);
            loadExistingGroups();
        }

        function closeGroupModal() {
            document.getElementById('group-modal').classList.add('hidden');
            loadMenuAdmin(); // é‡æ–°æ•´ç†å¤–å±¤åˆ—è¡¨
        }

        // --- Logo ä¸Šå‚³ ---
        async function uploadLogo() {
            const file = document.getElementById('logo-file').files[0];
            if(!file) return alert("è«‹é¸æ“‡åœ–ç‰‡");
            const path = `logo/store_logo_${Date.now()}.png`;
            const { data, error } = await _s.storage.from('assets').upload(path, file);
            if(!error) {
                const url = `${SUPABASE_URL}/storage/v1/object/public/assets/${path}`;
                await _s.from('store_settings').update({ logo_url: url }).eq('id', 1);
                alert("Logo ä¸Šå‚³æˆåŠŸï¼");
                loadSettingsAdmin();
            }
        }

        async function loadSettingsAdmin() {
            const { data } = await _s.from('store_settings').select('*').eq('id', 1).single();
            if(data?.logo_url) {
                document.getElementById('logo-preview-area').classList.remove('hidden');
                document.getElementById('admin-preview-logo').src = data.logo_url;
            }
        }

        // --- åŸºæœ¬é¤é»æ“ä½œ ---
        async function saveMenuItem() {
            const name = document.getElementById('m-name').value;
            const price = document.getElementById('m-price').value;
            const cid = document.getElementById('m-cat').value;
            const isSet = document.getElementById('m-is-set').checked;
            const file = document.getElementById('m-img').files[0];

            let imgUrl = "";
            if(file) {
                const path = `items/${Date.now()}.png`;
                await _s.storage.from('assets').upload(path, file);
                imgUrl = `${SUPABASE_URL}/storage/v1/object/public/assets/${path}`;
            }

            const { error } = await _s.from('menu_items').insert([{
                name, price, category_id: cid, is_set_menu: isSet, image_url: imgUrl
            }]);
            if(!error) { closeMenuModal(); loadMenuAdmin(); }
        }

        async function loadCategoriesAdmin() {
            const { data } = await _s.from('categories').select('*').order('sort_order');
            document.getElementById('cat-list').innerHTML = data.map(c => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                    <span class="font-bold text-sm">${c.name}</span>
                    <button onclick="deleteCat('${c.id}')" class="text-red-500 text-xs">åˆªé™¤</button>
                </div>
            `).join('');
            const mCat = document.getElementById('m-cat');
            if(mCat) mCat.innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function addCategory() {
            const name = document.getElementById('new-cat-name').value;
            if(!name) return;
            await _s.from('categories').insert([{ name }]);
            document.getElementById('new-cat-name').value = '';
            loadCategoriesAdmin();
        }

        function openMenuModal() { document.getElementById('menu-modal').classList.remove('hidden'); loadCategoriesAdmin(); }
        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        async function toggleHide(id, cur) { await _s.from('menu_items').update({ is_hidden: !cur }).eq('id', id); loadMenuAdmin(); }
        async function deleteItem(id) { if(confirm('åˆªé™¤é¤é»ï¼Ÿ')) { await _s.from('menu_items').delete().eq('id', id); loadMenuAdmin(); } }
        async function deleteCat(id) { if(confirm('åˆªé™¤åˆ†é¡åŠå…¶é¤é»ï¼Ÿ')) { await _s.from('categories').delete().eq('id', id); loadCategoriesAdmin(); } }

        // åˆå§‹åŒ–
        switchTab('orders');
    </script>
</body>
</html>
