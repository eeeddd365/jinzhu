<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœŸç ç®¡ç†å¾Œå° - å…¨åŠŸèƒ½ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p-green: #004d40; } 
        .bg-p-green { background-color: var(--p-green); }
        .text-p-green { color: var(--p-green); }
        input:focus { outline: none; border-color: var(--p-green); }
    </style>
</head>
<body class="bg-slate-100 flex min-h-screen text-slate-700">
    <aside class="w-64 bg-emerald-900 text-white p-6 sticky top-0 h-screen shadow-xl">
        <h2 class="text-xl font-bold mb-10 border-b border-emerald-700 pb-4 text-center tracking-widest text-emerald-400 font-serif">çœŸç  ADMIN</h2>
        <nav class="space-y-3">
            <button onclick="switchTab('orders')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ“‹ è¨‚å–®ç›£æ§</button>
            <button onclick="switchTab('categories')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ—‚ï¸ åˆ†é¡ç®¡ç†</button>
            <button onclick="switchTab('menu')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸ± èœå–®/ä»‹ç´¹ç·¨è¼¯</button>
            <button onclick="switchTab('flavors')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">ğŸŒ¶ï¸ å®¢è£½åŒ–å£å‘³å®šç¾©</button>
            <button onclick="switchTab('settings')" class="w-full text-left p-3 rounded hover:bg-emerald-800 transition">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <section id="sec-orders" class="space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-emerald-900">å³æ™‚è¨‚å–®ç®¡ç†</h2><button onclick="exportXls()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow">ğŸ“Š å°å‡º Excel</button></div>
            <div id="order-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="sec-categories" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-emerald-900">èœå–®åˆ†é¡ç·¨è¼¯</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm border max-w-md">
                <div class="flex gap-2 mb-6">
                    <input id="new-cat" class="border flex-1 p-3 rounded-xl bg-stone-50" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨± (å¦‚ï¼šé–‹èƒƒèœ)">
                    <button onclick="addCat()" class="bg-p-green text-white px-6 rounded-xl font-bold">æ–°å¢</button>
                </div>
                <div id="cat-list" class="space-y-3">
                    </div>
            </div>
        </section>

        <section id="sec-menu" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-emerald-900">èœå–®ç·¨è¼¯</h2><button onclick="openMenuModal()" class="bg-p-green text-white px-6 py-2 rounded-lg shadow-lg font-bold">+ æ–°å¢é¤é»/å¥—é¤</button></div>
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="sec-flavors" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-emerald-900">å®¢è£½åŒ–å£å‘³å®šç¾©</h2><button onclick="addFlvGroup()" class="bg-amber-600 text-white px-6 py-2 rounded-lg font-bold shadow-sm">+ æ–°å¢å®¢è£½åŒ–çµ„</button></div>
            <div id="flv-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </section>

        <section id="sec-settings" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-emerald-900">Logo ç·¨è¼¯</h2>
            <div class="bg-white p-6 rounded-2xl border max-w-md shadow-sm">
                <label class="block font-bold mb-4">æ›´æ–°é¤å»³ Logo</label>
                <input type="file" id="logo-file" class="mb-4 w-full border p-2 rounded-lg">
                <button onclick="uploadLogo()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold">ç¢ºèªä¸Šå‚³</button>
            </div>
        </section>
    </main>

    <div id="set-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="font-bold text-xl mb-4 text-p-green border-b pb-2 font-serif">å¥—é¤çµ„åˆé…å°</h3>
            <div class="space-y-5">
                <div class="grid grid-cols-2 gap-2">
                    <input id="g-name" placeholder="çµ„å(å¦‚:å‰èœé¸ä¸€)" class="border p-3 rounded-xl bg-stone-50">
                    <input id="g-limit" type="number" value="1" class="border p-3 rounded-xl bg-stone-50 text-center">
                </div>
                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                    <p class="text-xs font-bold text-emerald-800 mb-2">å¾å–®é»èœè‰²ä¸­æŒ‘é¸åŠ å…¥æ­¤çµ„ï¼š</p>
                    <select id="item-picker" class="w-full border p-3 mb-3 rounded-xl"></select>
                    <button onclick="addSetPick()" class="w-full bg-emerald-600 text-white py-2 rounded-xl text-sm font-bold">åŠ å…¥æ­¤é¸é …</button>
                    <div id="pick-list-view" class="mt-4 space-y-2"></div>
                </div>
                <button onclick="saveFullSet()" class="w-full bg-p-green text-white py-4 rounded-2xl font-bold text-lg shadow-lg">å„²å­˜æ­¤åˆ†çµ„è¨­å®š</button>
            </div>
            <button onclick="closeSetModal()" class="mt-6 text-gray-400 w-full underline">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[85vh]">
            <h3 class="font-bold text-xl mb-6 text-p-green border-l-4 border-p-gold pl-3">ç·¨è¼¯é¤é»è³‡è¨Š</h3>
            <input type="hidden" id="m-id">
            <div class="space-y-4">
                <input id="m-name" placeholder="é¤é»åç¨±" class="w-full border p-3 rounded-xl bg-stone-50 text-lg font-bold">
                <textarea id="m-desc" placeholder="é¤é»ä»‹ç´¹æ–‡å­—" class="w-full border p-3 rounded-xl bg-stone-50 h-24"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input id="m-price" type="number" placeholder="åƒ¹æ ¼" class="border p-3 rounded-xl bg-stone-50">
                    <select id="m-cat" class="border p-3 rounded-xl bg-stone-50"></select>
                </div>
                <div class="bg-stone-100 p-4 rounded-2xl">
                    <p class="text-[10px] font-bold text-gray-500 mb-3 tracking-widest uppercase">å®¢è£½åŒ–é¸é …é–‹é—œ</p>
                    <div id="flv-checks" class="grid grid-cols-2 gap-3 text-xs"></div>
                </div>
                <div class="p-2 border-2 border-dashed rounded-xl border-stone-200">
                    <label class="block text-xs font-bold text-gray-400 mb-1">ç…§ç‰‡ä¸Šå‚³</label>
                    <input type="file" id="m-img" class="w-full text-xs">
                </div>
                <label class="flex items-center gap-3 p-4 bg-emerald-50 rounded-2xl cursor-pointer font-bold border border-emerald-100">
                    <input type="checkbox" id="m-is-set" class="w-5 h-5 accent-emerald-600"> é€™æ˜¯ã€Œå¥—é¤ã€æ¨¡å¼
                </label>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-3 rounded-2xl font-bold text-gray-400">å–æ¶ˆ</button>
                <button onclick="saveItem()" class="flex-1 bg-p-green text-white py-3 rounded-2xl font-bold shadow-md">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let curItem = null, curPicks = [];

        function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            if(t==='orders') loadOrders(); 
            if(t==='menu') loadMenu(); 
            if(t==='categories') loadCats(); 
            if(t==='flavors') loadFlvs();
        }

        // --- è¨‚å–®è™•ç† ---
        async function loadOrders() {
            const { data } = await _s.from('orders').select('*').order('created_at', {ascending:false});
            document.getElementById('order-list').innerHTML = data.map(o => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border ${o.status==='synced'?'opacity-50 grayscale border-stone-200':'border-emerald-200'}">
                    <div class="flex justify-between font-bold text-lg mb-3">
                        <span class="text-p-green font-serif">${o.customer_name}</span>
                        <span class="text-p-gold">$${o.total_price}</span>
                    </div>
                    <div class="space-y-1 mb-4 text-sm text-stone-500 bg-stone-50 p-3 rounded-xl">
                        ${o.order_content.map(i => `â€¢ ${i.name}`).join('<br>')}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="sync('${o.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold border-2 ${o.status==='synced'?'bg-stone-100 text-stone-300':'border-p-green text-p-green active:bg-emerald-50'}">
                            ${o.status==='synced'?'å·²åŒæ­¥ POS':'æ¨™è¨˜ç‚ºå·²é»é¤'}
                        </button>
                        <button onclick="delOrder('${o.id}')" class="px-3 text-red-300 hover:text-red-500">âœ•</button>
                    </div>
                </div>`).join('');
            window.allOrders = data;
        }

        // --- åˆ†é¡ç®¡ç† (ä¿®å¾©ç‰ˆ) ---
        async function loadCats() {
            const { data } = await _s.from('categories').select('*').order('sort_order');
            const list = document.getElementById('cat-list');
            list.innerHTML = data.map(c => `
                <div class="flex justify-between items-center p-3 bg-stone-50 rounded-xl border border-stone-100 shadow-sm">
                    <span class="font-bold text-p-green">${c.name}</span>
                    <button onclick="delCat('${c.id}')" class="text-red-500 text-xs font-bold hover:bg-red-50 px-3 py-1 rounded-lg">åˆªé™¤</button>
                </div>`).join('');
        }

        async function addCat() {
            const name = document.getElementById('new-cat').value;
            if(!name) return alert("è«‹è¼¸å…¥åˆ†é¡åç¨±");
            const { error } = await _s.from('categories').insert([{ name }]);
            if(!error) { document.getElementById('new-cat').value = ""; loadCats(); }
        }

        // --- å£å‘³å®¢è£½åŒ– (ä¿®å¾©ç‰ˆ) ---
        async function loadFlvs() {
            const { data } = await _s.from('flavor_groups').select('*, flavor_options(*)');
            const grid = document.getElementById('flv-grid');
            grid.innerHTML = data.map(g => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-bold text-p-green text-lg font-serif">ğŸŒ¶ï¸ ${g.name}</h4>
                        <button onclick="delFlvGroup('${g.id}')" class="text-red-300 hover:text-red-500 text-xs">åˆªé™¤</button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${g.flavor_options.map(o => `<span class="bg-stone-100 px-3 py-1 rounded-full text-xs text-stone-500 border border-stone-200">${o.option_name}</span>`).join('')}
                    </div>
                </div>`).join('');
        }

        async function addFlvGroup() {
            const n = prompt("å®¢è£½åŒ–çµ„å (å¦‚: ç†Ÿåº¦, è¾£åº¦)");
            const o = prompt("é¸é …å…§å®¹ (è«‹ç”¨é€—è™Ÿåˆ†é–‹ï¼Œå¦‚: å…¨ç†Ÿ, ä¸ƒåˆ†, äº”åˆ†)");
            if(!n || !o) return alert("è«‹å®Œæ•´å¡«å¯«çµ„åèˆ‡é¸é …");
            const { data: g, error } = await _s.from('flavor_groups').insert([{ name: n }]).select();
            if(!error && g) {
                const optList = o.split(',').map(opt => ({ group_id: g[0].id, option_name: opt.trim() }));
                await _s.from('flavor_options').insert(optList);
                loadFlvs();
            }
        }

        // --- èœå–®èˆ‡å¥—é¤ ---
        async function loadMenu() {
            const { data } = await _s.from('menu_items').select('*, categories(name)').order('created_at', {ascending:false});
            document.getElementById('menu-grid').innerHTML = data.map(i => `
                <div class="bg-white rounded-2xl shadow-sm border border-stone-100 overflow-hidden">
                    <div class="h-32 bg-stone-50 flex items-center justify-center p-2">
                        <img src="${i.image_url || ''}" class="max-h-full max-w-full object-contain">
                    </div>
                    <div class="p-4 border-t">
                        <div class="flex justify-between font-bold mb-1"><span class="text-p-green truncate">${i.name}</span><span class="text-p-gold">$${i.price}</span></div>
                        <p class="text-[10px] text-gray-400 mb-4 line-clamp-1 italic">${i.description || 'å°šç„¡ä»‹ç´¹'}</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="editItem('${i.id}')" class="flex-1 py-1.5 rounded-lg bg-stone-100 text-stone-500 text-xs font-bold">ç·¨è¼¯</button>
                            ${i.is_set_menu ? `<button onclick="openSetModal('${i.id}')" class="flex-1 py-1.5 rounded-lg bg-amber-500 text-white text-xs font-bold shadow-sm">æ­é…å¥—é¤</button>` : ''}
                            <button onclick="delItem('${i.id}')" class="px-2 text-red-200">âœ•</button>
                        </div>
                    </div>
                </div>`).join('');
        }

        async function editItem(id) {
            const { data: i } = await _s.from('menu_items').select('*, item_flavor_relation(*)').eq('id', id).single();
            curItem = id;
            document.getElementById('m-id').value = id;
            document.getElementById('m-name').value = i.name;
            document.getElementById('m-price').value = i.price;
            document.getElementById('m-desc').value = i.description || '';
            document.getElementById('m-is-set').checked = i.is_set_menu;
            openMenuModal();
            setTimeout(() => {
                i.item_flavor_relation.forEach(r => {
                    const chk = document.querySelector(`.flv-chk[value="${r.flavor_group_id}"]`);
                    if(chk) chk.checked = true;
                });
            }, 500);
        }

        async function openSetModal(id) {
            curItem = id; curPicks = [];
            document.getElementById('set-modal').classList.remove('hidden');
            const { data } = await _s.from('menu_items').select('*').eq('is_set_menu', false);
            document.getElementById('item-picker').innerHTML = data.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            loadSavedGroups();
        }

        function addSetPick() {
            const el = document.getElementById('item-picker');
            curPicks.push({ id: el.value, name: el.options[el.selectedIndex].text });
            document.getElementById('pick-list-view').innerHTML += `<div class="bg-white border-2 border-emerald-500 p-2 rounded-xl text-xs shadow-sm">â— ${el.options[el.selectedIndex].text}</div>`;
        }

        async function saveFullSet() {
            const name = document.getElementById('g-name').value;
            const limit = document.getElementById('g-limit').value;
            if(!name || curPicks.length === 0) return alert("è«‹è¼¸å…¥çµ„åèˆ‡é¸æ“‡èœè‰²");
            const { data: g } = await _s.from('set_menu_groups').insert([{ parent_set_id: curItem, group_name: name, selection_limit: limit }]).select();
            if(g) {
                await _s.from('set_menu_contents').insert(curPicks.map(p => ({ group_id: g[0].id, item_id: p.id })));
                alert("åˆ†çµ„å„²å­˜æˆåŠŸ"); loadSavedGroups(); curPicks = []; document.getElementById('pick-list-view').innerHTML = "";
            }
        }

        async function loadSavedGroups() {
            const { data } = await _s.from('set_menu_groups').select('*, set_menu_contents(menu_items(*))').eq('parent_set_id', curItem);
            document.getElementById('pick-list-view').innerHTML = data.map(g => `
                <div class="p-3 bg-stone-100 rounded-xl border border-stone-200">
                    <div class="flex justify-between font-bold text-xs mb-1"><span>${g.group_name} (é™ ${g.selection_limit})</span><button onclick="delGrp('${g.id}')" class="text-red-500">åˆª</button></div>
                    <div class="text-[10px] text-gray-400">${g.set_menu_contents.map(c => c.menu_items.name).join('ã€')}</div>
                </div>`).join('');
        }

        // --- æ ¸å¿ƒå·¥å…· ---
        async function saveItem() {
            const id = document.getElementById('m-id').value;
            const file = document.getElementById('m-img').files[0];
            let url = "";
            if(file) {
                const path = `items/${Date.now()}.png`;
                await _s.storage.from('assets').upload(path, file);
                url = `${SUPABASE_URL}/storage/v1/object/public/assets/${path}`;
            }
            const p = { name: document.getElementById('m-name').value, price: document.getElementById('m-price').value, description: document.getElementById('m-desc').value, category_id: document.getElementById('m-cat').value, is_set_menu: document.getElementById('m-is-set').checked };
            if(url) p.image_url = url;
            const { data: saved } = id ? await _s.from('menu_items').update(p).eq('id', id).select() : await _s.from('menu_items').insert([p]).select();
            if(saved) {
                await _s.from('item_flavor_relation').delete().eq('item_id', saved[0].id);
                const rels = Array.from(document.querySelectorAll('.flv-chk:checked')).map(c => ({ item_id: saved[0].id, flavor_group_id: c.value }));
                await _s.from('item_flavor_relation').insert(rels);
                closeMenuModal(); loadMenu();
            }
        }

        async function openMenuModal() {
            document.getElementById('menu-modal').classList.remove('hidden');
            const { data: cats } = await _s.from('categories').select('*');
            document.getElementById('m-cat').innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const { data: flvs } = await _s.from('flavor_groups').select('*');
            document.getElementById('flv-checks').innerHTML = flvs.map(f => `<label class="flex items-center gap-1"><input type="checkbox" class="flv-chk" value="${f.id}"> ${f.name}</label>`).join('');
        }

        async function uploadLogo() {
            const f = document.getElementById('logo-file').files[0];
            if(!f) return;
            const p = `logo_${Date.now()}.png`;
            await _s.storage.from('assets').upload(p, f);
            const url = `${SUPABASE_URL}/storage/v1/object/public/assets/${p}`;
            await _s.from('store_settings').update({ logo_url: url }).eq('id', 1);
            alert("Logo å·²æˆåŠŸæ›´æ–°ï¼Œå‰å°é‡æ–°æ•´ç†å³å¯è¦‹ã€‚");
        }

        function exportXls() {
            const ws = XLSX.utils.json_to_sheet(window.allOrders.map(o => ({ æ™‚é–“: new Date(o.created_at).toLocaleString(), å®¢æˆ¶: o.customer_name, é›»è©±: o.phone, é‡‘é¡: o.total_price, å…§å®¹: o.order_content.map(i=>i.name).join('; ') })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è¨‚å–®");
            XLSX.writeFile(wb, `çœŸç è¨‚å–®_${new Date().toLocaleDateString()}.xlsx`);
        }

        async function sync(id) { await _s.from('orders').update({ status: 'synced' }).eq('id', id); loadOrders(); }
        async function delItem(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { await _s.from('menu_items').delete().eq('id', id); loadMenu(); } }
        async function delCat(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { await _s.from('categories').delete().eq('id', id); loadCats(); } }
        async function delGrp(id) { await _s.from('set_menu_groups').delete().eq('id', id); loadSavedGroups(); }
        async function delFlvGroup(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { await _s.from('flavor_groups').delete().eq('id', id); loadFlvs(); } }
        async function delOrder(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { await _s.from('orders').delete().eq('id', id); loadOrders(); } }

        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        function closeSetModal() { document.getElementById('set-modal').classList.add('hidden'); }
        
        switchTab('orders');
    </script>
</body>
</html>
