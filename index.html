<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸç  å°ç£ä½³å‘³ JIN-ZHU | ç·šä¸Šé»é¤</title>
    
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/css/animate.css">
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/css/all.min.css">
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/css/ionicons.min.css">
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/css/style.css">
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/css/responsive.css">
    <link rel="stylesheet" href="https://www.jinzhu.com.tw/color/theme-stb.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { --p-green: #004d40; --p-gold: #b89150; --p-cream: #f9f5f0; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--p-cream); }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        
        /* è¦†å¯«å®˜æ–¹ CSS è¡çª */
        .navbar-brand img { max-height: 50px; }
        .btn-primary { background-color: var(--p-green) !important; border-color: var(--p-green) !important; color: #fff !important; }
        .btn-outline { border: 2px solid var(--p-green); color: var(--p-green) !important; }
        
        /* KV è¼ªæ’­å€å¡Šæ¨£å¼ */
        .kv-section { position: relative; height: 500px; width: 100%; overflow: hidden; }
        .kv-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); z-index: 1; }
        #kv-bg { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.8s ease-in-out; }

        /* é»é¤å¡ç‰‡æ‡¸æµ® */
        .order-card { margin-top: -80px; position: relative; z-index: 10; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
        
        .opt-selected { border: 3px solid var(--p-gold) !important; background-color: #fdf6e9 !important; font-weight: bold; }
        .flavor-selected { border-color: var(--p-gold) !important; background-color: var(--p-green) !important; color: white !important; }
        .img-contain { width: 100%; height: 100%; object-fit: contain; background: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <header class="header_wrap fixed-top dark_skin main_menu_uppercase bg-white shadow-sm">
        <div class="container">
            <nav class="navbar navbar-expand-lg flex justify-between items-center py-2">
                <a class="navbar-brand" href="#">
                    <img src="https://www.jinzhu.com.tw/images/Jinzhu_logo.svg" alt="logo">
                </a>
                <div class="hidden md:block">
                    <ul class="navbar-nav flex gap-4 text-sm font-medium text-p-green">
                        <li><a href="#" class="hover:text-p-gold">é—œæ–¼çœŸç </a></li>
                        <li><a href="#" class="hover:text-p-gold text-p-gold font-bold">ç·šä¸Šé»é¤</a></li>
                        <li><a href="#" class="hover:text-p-gold">åˆ†åº—è³‡è¨Š</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <div class="kv-section pt-[70px]">
        <div class="kv-overlay"></div>
        <img id="kv-bg" src="" class="opacity-0">
        <div class="absolute inset-0 z-10 flex flex-col items-center justify-center text-white text-center">
            <h2 class="text-4xl md:text-6xl font-bold font-serif tracking-[0.2em] drop-shadow-xl slide-up">å°å¼æ‰‹è·¯èœ</h2>
            <p class="mt-4 text-p-gold tracking-[0.5em] font-light text-lg slide-up">ç¶“å…¸å‚³æ‰¿ Â· çœŸèª æ¬¾å¾…</p>
        </div>
    </div>

    <main class="max-w-xl mx-auto p-4">
        <section id="step-1" class="slide-up">
            <div class="order-card p-8 rounded-[2.5rem] shadow-2xl border border-white/50">
                <h2 class="text-2xl font-bold text-p-green text-center mb-8 font-serif">é¡§å®¢é å®šç™»è¨˜</h2>
                <div class="space-y-5">
                    <div class="group">
                        <label class="text-xs font-bold text-stone-400 ml-2 mb-1 block">è¨‚ä½äººå§“å</label>
                        <input type="text" id="custName" placeholder="è«‹è¼¸å…¥å§“å" class="w-full border-b-2 border-stone-200 p-3 bg-transparent outline-none focus:border-p-green text-lg transition">
                    </div>
                    <div class="group">
                        <label class="text-xs font-bold text-stone-400 ml-2 mb-1 block">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="custPhone" placeholder="è«‹è¼¸å…¥é›»è©±" class="w-full border-b-2 border-stone-200 p-3 bg-transparent outline-none focus:border-p-green text-lg transition">
                    </div>
                    <button onclick="startOrder()" class="w-full btn-primary py-4 rounded-full font-bold text-xl transition mt-4 active:scale-95">
                        é–‹å§‹æŒ‘é¸å¥½æ»‹å‘³
                    </button>
                </div>
            </div>
        </section>

        <section id="step-2" class="hidden">
            <div id="cat-nav" class="flex gap-3 overflow-x-auto py-4 sticky top-[70px] bg-p-cream/95 backdrop-blur-md z-40 no-scrollbar border-b border-stone-100"></div>
            <div id="menu-grid" class="grid grid-cols-1 gap-6 mt-4"></div>
        </section>

        <section id="step-3" class="hidden py-16 text-center px-4">
            <div class="bg-white p-10 rounded-[3rem] shadow-2xl border-t-8 border-p-green text-center">
                <div class="text-7xl mb-6 animate-bounce">ğŸ¥¢</div>
                <h2 class="text-2xl font-bold text-p-green mb-4 font-serif">å·²æ”¶åˆ°æ‚¨çš„é å®šé¤é»</h2>
                <p class="text-stone-500 mb-10 font-medium">å¦‚æœ‰ä»»ä½•å•é¡Œæ­¡è¿è‡´é›»ï¼š<br><b class="text-p-gold text-2xl">04-3702-7538</b><br>çœŸç å°ä¸­æ–‡å¿ƒåº— èª æ‘¯æ­¡è¿æ‚¨</p>
                <button onclick="location.reload()" class="w-full max-w-xs mx-auto btn-outline py-4 rounded-full font-bold text-lg">è¿”å›é¦–é </button>
            </div>
        </section>
    </main>

    <div id="detail-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[92vh] slide-up">
            <div class="h-60 bg-white relative border-b flex-shrink-0">
                <img id="detail-img" src="" class="img-contain">
                <button onclick="closeDetail()" class="absolute top-4 right-4 bg-black/30 text-white w-10 h-10 rounded-full text-2xl flex items-center justify-center">âœ•</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-white">
                <h3 id="detail-title" class="text-2xl font-bold text-p-green mb-1 font-serif"></h3>
                <p id="detail-desc" class="text-stone-500 text-sm leading-relaxed mb-6"></p>
                <div id="flavor-container" class="space-y-6 mb-8"></div>
                <div id="set-group-container" class="space-y-8 border-t pt-6"></div>
            </div>
            <div class="p-5 bg-stone-50 flex gap-4 border-t flex-shrink-0">
                <button onclick="closeDetail()" class="flex-1 py-4 text-stone-400 font-bold text-lg">å–æ¶ˆ</button>
                <button id="add-btn" class="flex-1 btn-primary py-4 rounded-full font-bold text-lg shadow-md transition">ç¢ºèªåŠ å…¥</button>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="fixed inset-0 bg-black/90 z-[110] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[85vh] slide-up">
            <div class="p-6 border-b bg-stone-50 text-center"><h3 class="text-xl font-bold text-p-green font-serif">é è¦½é»é¤æ˜ç´°</h3></div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="preview-list" class="space-y-4"></div>
                <div class="mt-8 border-t pt-4">
                    <label class="block text-sm font-bold text-p-green mb-2">è¨‚å–®å‚™è¨»</label>
                    <textarea id="order-note" class="w-full border-2 rounded-2xl p-4 bg-stone-50 text-sm outline-none focus:border-p-gold h-24 resize-none" placeholder="ç‰¹æ®Šéœ€æ±‚è«‹è¨»æ˜..."></textarea>
                </div>
            </div>
            <div class="p-6 bg-white border-t space-y-3">
                <div class="flex justify-between items-center px-2"><span class="font-bold text-stone-400">ç¸½è¨ˆé‡‘é¡</span><span class="text-2xl font-black text-p-gold" id="preview-total">$0</span></div>
                <div class="flex gap-4"><button onclick="closePreview()" class="flex-1 py-4 text-stone-400 font-bold border rounded-full">å†é»ä¸€äº›</button><button onclick="finalSubmit()" class="flex-1 btn-primary py-4 rounded-full font-bold text-lg">ç¢ºèªé å®š</button></div>
            </div>
        </div>
    </div>

    <div id="cart-bar" class="fixed bottom-6 left-4 right-4 max-w-xl mx-auto z-50 hidden">
        <button onclick="openPreview()" class="w-full btn-primary p-2 rounded-full shadow-2xl flex justify-between items-center pr-2 pl-8 border-2 border-white/20 active:scale-95 transition">
            <span class="font-bold tracking-widest text-lg font-serif">æŸ¥çœ‹é å®šæ˜ç´°</span>
            <div id="cart-count" class="bg-p-gold text-white w-12 h-12 rounded-full flex items-center justify-center font-black text-xl shadow-inner">0</div>
        </button>
    </div>

    <script>
        const SUPABASE_URL = 'https://pydlnqriztpzgxbjuohm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ISKUWOXUR9A-1y81xCOUXg_8-zNle3v';
        const _s = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let menuData = [], cart = [], guest = {}, tempItem = null, sels = { flavors: {}, groups: {} };

        // è‡ªå‹•è¾¨è­˜æ‰‹æ©Ÿç‰ˆæˆ–é›»è…¦ç‰ˆèƒŒæ™¯åœ–
        function setKV() {
            const isMobile = window.innerWidth <= 768;
            const baseUrl = "https://www.jinzhu.com.tw/storage/website/kv/jinzhu20230904143032_";
            const kvImg = document.getElementById('kv-bg');
            kvImg.src = isMobile ? baseUrl + "Mobile-KV.jpeg" : baseUrl + "PC-KV.jpeg";
            kvImg.onload = () => kvImg.classList.replace('opacity-0', 'opacity-100');
        }

        (async function init() {
            setKV();
            const { data } = await _s.from('store_settings').select('logo_url').eq('id', 1).single();
            if (data?.logo_url) {
                document.querySelectorAll('.navbar-brand img').forEach(img => img.src = data.logo_url);
            }
        })();

        async function startOrder() {
            guest = { name: document.getElementById('custName').value, phone: document.getElementById('custPhone').value };
            if(!guest.name || !guest.phone) return alert("è«‹è¼¸å…¥é å®šè³‡æ–™");
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            document.getElementById('cart-bar').classList.remove('hidden');
            loadContent();
        }

        async function loadContent() {
            const { data: cats } = await _s.from('categories').select('*').eq('is_visible', true).order('sort_order');
            const { data: items } = await _s.from('menu_items').select('*, item_flavor_relation(flavor_groups(*, flavor_options(*))), set_menu_groups(*, set_menu_contents(menu_items(*, item_flavor_relation(flavor_groups(*, flavor_options(*))))))').eq('is_hidden', false);
            menuData = items;
            const nav = document.getElementById('cat-nav');
            nav.innerHTML = cats.map(c => `<button class="cat-btn px-7 py-2 rounded-full text-sm font-bold shadow-sm whitespace-nowrap" onclick="renderItems('${c.id}', this)">${c.name}</button>`).join('');
            if(cats.length) renderItems(cats[0].id, nav.firstChild);
        }

        function renderItems(cid, el) {
            document.querySelectorAll('#cat-nav button').forEach(b => b.classList.remove('cat-active'));
            if(el) el.classList.add('cat-active');
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = menuData.filter(i => i.category_id === cid).map(i => `
                <div class="bg-white rounded-3xl overflow-hidden shadow-sm flex h-36 border border-stone-100 clickable" onclick="openDetail('${i.id}')">
                    <div class="w-36 h-full bg-white flex-shrink-0"><img src="${i.image_url || ''}" class="img-contain"></div>
                    <div class="p-4 flex flex-col justify-between flex-1 overflow-hidden">
                        <div><h3 class="font-bold text-p-green text-lg font-serif truncate">${i.name}</h3><p class="text-[11px] text-stone-400 line-clamp-2 mt-1 leading-relaxed">${i.description || ''}</p></div>
                        <div class="flex justify-between items-end"><span class="text-p-gold font-bold font-serif text-lg">$${i.price}</span><span class="text-[10px] bg-stone-100 text-stone-400 px-3 py-1 rounded-full font-bold">é»é¸</span></div>
                    </div>
                </div>`).join('');
        }

        function openDetail(id) {
            tempItem = menuData.find(i => i.id === id);
            if(!tempItem) return;
            sels = { flavors: {}, groups: {} };
            document.getElementById('detail-img').src = tempItem.image_url || '';
            document.getElementById('detail-title').innerText = tempItem.name;
            document.getElementById('detail-desc').innerText = tempItem.description || "çœŸåˆ‡æ»‹å‘³ï¼Œèª æ‘¯æ¬¾å¾…ã€‚";
            renderFlavorList(tempItem.item_flavor_relation, 'flavor-container', 'main');
            const setArea = document.getElementById('set-group-container');
            setArea.innerHTML = tempItem.is_set_menu ? tempItem.set_menu_groups.map(g => {
                sels.groups[g.id] = []; 
                return `<div><div class="flex justify-between items-center mb-4"><p class="font-bold text-p-green border-l-4 border-p-gold pl-3 text-lg font-serif">${g.group_name}</p><span class="text-[10px] bg-stone-100 text-stone-400 px-2 py-1 rounded">å¿…é¸ ${g.selection_limit} é …</span></div>
                        <div class="grid grid-cols-1 gap-3">${g.set_menu_contents.map(c => renderSetOptionUI(c.menu_items, g.id, g.selection_limit)).join('')}</div></div>`;
            }).join('') : "";
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('add-btn').onclick = confirmAdd;
        }

        function renderFlavorList(relations, targetId, parentType, optId = '') {
            const container = document.getElementById(targetId);
            if(parentType === 'main') container.innerHTML = '';
            container.innerHTML += relations.map(r => `<div><p class="text-[11px] font-bold text-stone-400 mb-3 uppercase tracking-widest">ã€é¸å– ${r.flavor_groups.name}ã€‘</p>
                <div class="flex flex-wrap gap-2">${r.flavor_groups.flavor_options.map(o => `<div onclick="selectFlavor(this, '${r.flavor_groups.id}', '${o.option_name}', '${parentType}', '${optId}')" class="px-5 py-2 border-2 border-stone-100 rounded-full text-xs cursor-pointer bg-stone-50 transition">${o.option_name}</div>`).join('')}</div></div>`).join('');
        }

        function renderSetOptionUI(item, groupId, limit) {
            const hasFlavor = item.item_flavor_relation?.length > 0;
            return `<div class="set-option-card border-2 border-stone-50 rounded-2xl overflow-hidden transition-all">
                    <div onclick="handleSetPick(this, '${groupId}', '${item.id}', '${item.name}', ${limit}, ${hasFlavor})" class="p-4 bg-stone-50 flex justify-between items-center cursor-pointer">
                        <span class="font-bold text-stone-700">${item.name}</span>
                        ${hasFlavor ? '<span class="text-[10px] text-p-gold font-bold">â— å£å‘³å¯èª¿</span>' : ''}
                    </div>
                    <div id="flavor-sub-${item.id}" class="bg-stone-100/50 p-4 hidden space-y-4 border-t border-white"></div>
                </div>`;
        }

        function selectFlavor(el, gid, name, type, optId) {
            Array.from(el.parentElement.children).forEach(c => c.classList.remove('flavor-selected'));
            el.classList.add('flavor-selected');
            if(type === 'main') sels.flavors[gid] = name;
            else { for(let g in sels.groups) { const target = sels.groups[g].find(x => x.id === optId); if(target) target.flavorNote = name; } }
        }

        function handleSetPick(el, gid, itemId, itemName, limit, hasFlavor) {
            const card = el.parentElement;
            const subArea = document.getElementById(`flavor-sub-${itemId}`);
            if(limit === 1) {
                Array.from(card.parentElement.children).forEach(s => { s.classList.remove('opt-selected'); const sub = s.querySelector('div[id^="flavor-sub-"]'); if(sub) sub.classList.add('hidden'); });
                card.classList.add('opt-selected');
                sels.groups[gid] = [{ id: itemId, name: itemName, flavorNote: '' }];
                if(hasFlavor) { const original = menuData.find(m => m.id === itemId); subArea.innerHTML = ''; renderFlavorList(original.item_flavor_relation, subArea.id, 'sub', itemId); subArea.classList.remove('hidden'); }
            } else {
                let groupSels = sels.groups[gid];
                const idx = groupSels.findIndex(x => x.id === itemId);
                if(idx > -1) { groupSels.splice(idx, 1); card.classList.remove('opt-selected'); subArea.classList.add('hidden'); }
                else if(groupSels.length < limit) {
                    groupSels.push({ id: itemId, name: itemName, flavorNote: '' });
                    card.classList.add('opt-selected');
                    if(hasFlavor) { const original = menuData.find(m => m.id === itemId); subArea.innerHTML = ''; renderFlavorList(original.item_flavor_relation, subArea.id, 'sub', itemId); subArea.classList.remove('hidden'); }
                }
            }
        }

        function confirmAdd() {
            if(tempItem.is_set_menu) {
                for(let g of tempItem.set_menu_groups) {
                    if(!sels.groups[g.id] || sels.groups[g.id].length < g.selection_limit) return alert(`ã€${g.group_name}ã€‘æœªé¸æ»¿ï¼`);
                    for(let p of sels.groups[g.id]) {
                        const original = menuData.find(m => m.id === p.id);
                        if(original.item_flavor_relation?.length > 0 && !p.flavorNote) return alert(`è«‹ç‚ºã€${p.name}ã€‘é¸æ“‡å£å‘³ã€‚`);
                    }
                }
            }
            if(tempItem.item_flavor_relation?.length > 0 && Object.keys(sels.flavors).length < tempItem.item_flavor_relation.length) return alert("è«‹é¸æ“‡å®¢è£½åŒ–å£å‘³ã€‚");
            const fn = Object.values(sels.flavors).join('/');
            const sn = Object.values(sels.groups).flat().map(x => x.name + (x.flavorNote ? ` [${x.flavorNote}]` : '')).join('ã€');
            cart.push({ name: `${tempItem.name}${fn ? ` [${fn}]` : ''}${sn ? ` (${sn})` : ''}`, price: Number(tempItem.price) });
            document.getElementById('cart-count').innerText = cart.length;
            closeDetail();
        }

        function openPreview() {
            if(!cart.length) return alert("è³¼ç‰©è»Šç›®å‰æ²’æ±è¥¿å–”");
            const list = document.getElementById('preview-list');
            list.innerHTML = cart.map((item, idx) => `
                <div class="flex justify-between items-start bg-stone-50 p-4 rounded-2xl border border-stone-100 shadow-sm">
                    <div class="flex-1"><p class="font-bold text-p-green">${item.name}</p><p class="text-p-gold font-serif text-sm mt-1">$${item.price}</p></div>
                    <button onclick="removeItem(${idx})" class="text-red-300 hover:text-red-500 p-2 text-xl">âœ•</button>
                </div>`).join('');
            document.getElementById('preview-total').innerText = `$${cart.reduce((s, i) => s + i.price, 0)}`;
            document.getElementById('preview-modal').classList.remove('hidden');
        }

        function removeItem(idx) { cart.splice(idx, 1); document.getElementById('cart-count').innerText = cart.length; if(!cart.length) closePreview(); else openPreview(); }
        function closePreview() { document.getElementById('preview-modal').classList.add('hidden'); }
        function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); }

        async function finalSubmit() {
            const note = document.getElementById('order-note').value;
            const total = cart.reduce((s,i) => s + i.price, 0);
            const { error } = await _s.from('orders').insert([{ customer_name: guest.name, phone: guest.phone, order_content: cart, total_price: total, note: note }]);
            if(!error) { document.getElementById('preview-modal').classList.add('hidden'); document.getElementById('step-2').classList.add('hidden'); document.getElementById('cart-bar').classList.add('hidden'); document.getElementById('step-3').classList.remove('hidden'); window.scrollTo(0,0); }
        }
    </script>
</body>
</html>
